
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>linefinder.tests.test_classify &#8212; linefinder 0.9.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">linefinder 0.9.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for linefinder.tests.test_classify</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&#39;&#39;&#39;Testing for classify.py</span>

<span class="sd">@author: Zach Hafen</span>
<span class="sd">@contact: zachary.h.hafen@gmail.com</span>
<span class="sd">@status: Development</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">mock</span> <span class="k">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">PropertyMock</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.testing</span> <span class="k">as</span> <span class="nn">npt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">import</span> <span class="nn">galaxy_dive.read_data.ahf</span> <span class="k">as</span> <span class="nn">read_ahf</span>
<span class="kn">from</span> <span class="nn">linefinder</span> <span class="k">import</span> <span class="n">classify</span>
<span class="kn">import</span> <span class="nn">linefinder.analyze_data.worldlines</span> <span class="k">as</span> <span class="nn">analyze_worldlines</span>

<span class="c1">########################################################################</span>
<span class="c1"># Global Variables Useful for Testing</span>
<span class="c1">########################################################################</span>

<span class="n">default_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;halo_data_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;./tests/data/ahf_test_data&#39;</span><span class="p">,</span>
    <span class="s1">&#39;out_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;./tests/data/tracking_output&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;test_classify&#39;</span><span class="p">,</span>
    <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;wind_cut&#39;</span><span class="p">:</span> <span class="mf">2.</span><span class="p">,</span>
    <span class="s1">&#39;absolute_wind_cut&#39;</span><span class="p">:</span> <span class="mf">15.</span><span class="p">,</span>
    <span class="s1">&#39;t_pro&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
    <span class="s1">&#39;t_m&#39;</span><span class="p">:</span> <span class="mf">500.</span><span class="p">,</span>
    <span class="s1">&#39;velocity_scale&#39;</span><span class="p">:</span> <span class="s1">&#39;Vc(Rvir)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;min_gal_density&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;pp_classifications_to_save&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

<span class="n">default_ptrack</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;mt_gal_id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
        <span class="p">[</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
        <span class="p">[</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">]),</span>
    <span class="s1">&#39;gal_id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
        <span class="p">[</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
        <span class="p">[</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">]),</span>
    <span class="s1">&#39;PType&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
        <span class="p">[</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
        <span class="p">[</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">]),</span>
    <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span> <span class="p">[</span> <span class="mf">41792.1633</span>    <span class="p">,</span>  <span class="mf">44131.2309735</span> <span class="p">,</span>  <span class="mf">46267.67030708</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mf">38198.04856455</span><span class="p">,</span>  <span class="mf">42852.63974461</span><span class="p">,</span>  <span class="mf">43220.86278364</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mf">34972.28497249</span><span class="p">,</span>  <span class="mf">39095.17772698</span><span class="p">,</span>  <span class="mf">39446.83170768</span> <span class="p">],</span>
            <span class="p">[</span>             <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span> <span class="p">],</span>
            <span class="p">[</span>             <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span> <span class="p">],</span> <span class="p">],</span>
        <span class="p">[</span> <span class="p">[</span> <span class="mf">41792.1633</span>    <span class="p">,</span>  <span class="mf">44131.2309735</span> <span class="p">,</span>  <span class="mf">46267.67030708</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mf">39109.18846174</span><span class="p">,</span>  <span class="mf">41182.20608191</span><span class="p">,</span>  <span class="mf">43161.6788352</span>  <span class="p">],</span>
            <span class="p">[</span> <span class="mf">35829.91969126</span><span class="p">,</span>  <span class="mf">37586.13659658</span><span class="p">,</span>  <span class="mf">39375.69670048</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mf">32543.5697382</span> <span class="p">,</span>  <span class="mf">33981.19081307</span><span class="p">,</span>  <span class="mf">35583.36876478</span> <span class="p">],</span>
            <span class="p">[</span>  <span class="mf">3245.25202392</span><span class="p">,</span>   <span class="mf">3136.94192456</span><span class="p">,</span>   <span class="mf">3317.2277023</span>  <span class="p">],</span> <span class="p">],</span>
        <span class="p">[</span> <span class="p">[</span>             <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mf">39109.18846174</span><span class="p">,</span>  <span class="mf">41182.20608191</span><span class="p">,</span>  <span class="mf">43161.6788352</span>  <span class="p">],</span>
            <span class="p">[</span>             <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span> <span class="p">],</span>
            <span class="p">[</span>             <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span> <span class="p">],</span>
            <span class="p">[</span>             <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span><span class="p">,</span>              <span class="mf">0.</span> <span class="p">],</span> <span class="p">],</span>
        <span class="p">]),</span>
    <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span> <span class="p">[</span><span class="o">-</span><span class="mf">48.53</span><span class="p">,</span>  <span class="mf">72.1</span> <span class="p">,</span>  <span class="mf">96.12</span><span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">23.75</span><span class="p">,</span>  <span class="mf">91.13</span><span class="p">,</span>  <span class="mf">80.57</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">20.92</span><span class="p">,</span>  <span class="mf">92.55</span><span class="p">,</span>  <span class="mf">75.86</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">17.9</span> <span class="p">,</span>  <span class="mf">92.69</span><span class="p">,</span>  <span class="mf">70.54</span><span class="p">],</span>
            <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span> <span class="p">],</span> <span class="p">],</span>
        <span class="p">[</span> <span class="p">[</span><span class="o">-</span><span class="mf">48.53</span><span class="p">,</span>  <span class="mf">72.1</span> <span class="p">,</span>  <span class="mf">96.12</span><span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">49.05</span><span class="p">,</span>  <span class="mf">72.73</span><span class="p">,</span>  <span class="mf">96.86</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">48.89</span><span class="p">,</span>  <span class="mf">73.77</span><span class="p">,</span>  <span class="mf">97.25</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">49.75</span><span class="p">,</span>  <span class="mf">75.68</span><span class="p">,</span>  <span class="mf">96.52</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">12.43</span><span class="p">,</span>  <span class="mf">39.47</span><span class="p">,</span>  <span class="mf">13.</span>  <span class="p">],</span> <span class="p">],</span>
        <span class="p">[</span> <span class="p">[</span><span class="o">-</span><span class="mf">48.53</span> <span class="o">+</span> <span class="mf">100.</span><span class="p">,</span>  <span class="mf">72.1</span> <span class="p">,</span>  <span class="mf">96.12</span><span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">49.05</span><span class="p">,</span>  <span class="mf">72.73</span><span class="p">,</span>  <span class="mf">96.86</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">48.89</span><span class="p">,</span>  <span class="mf">73.77</span><span class="p">,</span>  <span class="mf">97.25</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">49.75</span><span class="p">,</span>  <span class="mf">75.68</span><span class="p">,</span>  <span class="mf">96.52</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">12.43</span><span class="p">,</span>  <span class="mf">39.47</span><span class="p">,</span>  <span class="mf">13.</span>  <span class="p">],</span> <span class="p">],</span>
        <span class="p">]),</span>
    <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">10</span> <span class="p">]),</span>
    <span class="s1">&#39;redshift&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.</span>        <span class="p">,</span>  <span class="mf">0.06984665</span><span class="p">,</span>  <span class="mf">0.16946003</span><span class="p">,</span> <span class="mf">0.28952773953090749</span><span class="p">,</span> <span class="mf">12.310917860336163</span> <span class="p">]),</span>
    <span class="p">}</span>

<span class="n">default_ptrack_attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;main_mt_halo_id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;hubble&#39;</span><span class="p">:</span> <span class="mf">0.70199999999999996</span><span class="p">,</span>
    <span class="s1">&#39;omega_lambda&#39;</span><span class="p">:</span> <span class="mf">0.72799999999999998</span><span class="p">,</span>
    <span class="s1">&#39;omega_matter&#39;</span><span class="p">:</span> <span class="mf">0.27200000000000002</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1">########################################################################</span>
<span class="c1"># Test Cases</span>
<span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestReadPTrack"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestReadPTrack">[docs]</a><span class="k">class</span> <span class="nc">TestReadPTrack</span><span class="p">(</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span> <span class="p">):</span>

<div class="viewcode-block" id="TestReadPTrack.setUp"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestReadPTrack.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classify</span><span class="o">.</span><span class="n">Classifier</span><span class="p">(</span> <span class="o">**</span><span class="n">default_kwargs</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestReadPTrack.test_basic"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestReadPTrack.test_basic">[docs]</a>    <span class="k">def</span> <span class="nf">test_basic</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">read_data_files</span><span class="p">()</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="mf">1.700689e-08</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span><span class="s1">&#39;Den&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div></div>

<span class="c1">########################################################################</span>
<span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestDerivedFunctions"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestDerivedFunctions">[docs]</a><span class="k">class</span> <span class="nc">TestDerivedFunctions</span><span class="p">(</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span> <span class="p">):</span>

<div class="viewcode-block" id="TestDerivedFunctions.setUp"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestDerivedFunctions.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classify</span><span class="o">.</span><span class="n">Classifier</span><span class="p">(</span> <span class="o">**</span><span class="n">default_kwargs</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestDerivedFunctions.test_get_radial_velocity"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestDerivedFunctions.test_get_radial_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_radial_velocity</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">read_data_files</span><span class="p">()</span>

        <span class="c1"># Set the second particle at snapshot 550 to be at the center of the main halo at that redshift</span>
        <span class="c1"># Also set the velocity of the second particle at snapshot 550 to the velocity of the main halo at that redshift</span>
        <span class="c1"># This should result in an identically 0 radial velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span> <span class="s1">&#39;P&#39;</span> <span class="p">][</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">29372.26565053</span><span class="p">,</span>  <span class="mf">30929.16894187</span><span class="p">,</span>  <span class="mf">32415.81701217</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span> <span class="s1">&#39;P&#39;</span> <span class="p">][</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span><span class="s1">&#39;redshift&#39;</span><span class="p">][</span> <span class="mi">1</span> <span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack_attrs</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span> <span class="s1">&#39;V&#39;</span> <span class="p">][</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="o">-</span><span class="mf">49.05</span><span class="p">,</span>  <span class="mf">72.73</span><span class="p">,</span>  <span class="mf">96.86</span> <span class="p">])</span>

        <span class="c1"># Get the result</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_radial_velocity</span><span class="p">()</span>

        <span class="c1"># Make sure we have the right shape.</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span> <span class="s1">&#39;Den&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Make sure that we have 0 radial velocity when we should</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">result</span><span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-3</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestDerivedFunctions.test_get_circular_velocity"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestDerivedFunctions.test_get_circular_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_circular_velocity</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">read_data_files</span><span class="p">()</span>

        <span class="c1"># What our actual circular velocity is</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_circular_velocity</span><span class="p">()</span>

        <span class="c1"># Make sure we have the right dimensions</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="p">)</span>

        <span class="c1"># We expect the circular velocity of a 1e12 Msun galaxy to be roughly ~100 km/s</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="mf">100.</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">600</span><span class="p">]</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.5</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestDerivedFunctions.test_get_time_difference"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestDerivedFunctions.test_get_time_difference">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_time_difference</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">read_data_files</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_time_difference</span><span class="p">()</span>

        <span class="c1"># Expected difference in time, from NED&#39;s cosmology calculator.</span>
        <span class="n">travel_time_at_snum_550</span> <span class="o">=</span> <span class="mf">0.927</span> <span class="c1"># In Gyr</span>
        <span class="n">travel_time_at_snum_600</span> <span class="o">=</span> <span class="mf">2.104</span> <span class="c1"># In Gyr</span>
        <span class="n">expected_0</span> <span class="o">=</span> <span class="n">travel_time_at_snum_550</span>
        <span class="n">expected_1</span> <span class="o">=</span> <span class="n">travel_time_at_snum_600</span> <span class="o">-</span> <span class="n">travel_time_at_snum_550</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected_0</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected_1</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-3</span><span class="p">)</span></div></div>

<span class="c1">########################################################################</span>
<span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers">[docs]</a><span class="k">class</span> <span class="nc">TestIdentifyAccrectionEjectionAndMergers</span><span class="p">(</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span> <span class="p">):</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.setUp"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classify</span><span class="o">.</span><span class="n">Classifier</span><span class="p">(</span> <span class="o">**</span><span class="n">default_kwargs</span> <span class="p">)</span>

        <span class="c1"># Emulate the loading data phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span> <span class="o">=</span> <span class="n">default_ptrack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack_attrs</span> <span class="o">=</span> <span class="n">default_ptrack_attrs</span>

        <span class="c1"># Put in the number of snapshots and particles so that the function works correctly.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_snap</span> <span class="o">=</span> <span class="n">default_ptrack</span><span class="p">[</span><span class="s1">&#39;gal_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="n">default_ptrack</span><span class="p">[</span><span class="s1">&#39;gal_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Force the first valid snapshot to be snapshot 10, to ensure compatibility with</span>
        <span class="c1"># previous tests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_main_mt_halo_first_snap</span> <span class="o">=</span> <span class="mi">10</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_other_gal"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_other_gal">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_is_in_other_gal</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span> <span class="o">=</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">(</span> <span class="n">default_kwargs</span><span class="p">[</span><span class="s1">&#39;halo_data_dir&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span><span class="o">.</span><span class="n">get_mtree_halos</span><span class="p">(</span> <span class="s1">&#39;snum&#39;</span> <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Run the function</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_is_in_other_gal</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_other_gal_density_criterion"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_other_gal_density_criterion">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_is_in_other_gal_density_criterion</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test we can identify when a particle is in another galaxy, including some minimum density criterion for gas.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Change parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">min_gal_density</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="c1"># Setup Test Data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span> <span class="o">=</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">(</span> <span class="n">default_kwargs</span><span class="p">[</span><span class="s1">&#39;halo_data_dir&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span><span class="o">.</span><span class="n">get_mtree_halos</span><span class="p">(</span> <span class="s1">&#39;snum&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span><span class="s1">&#39;Den&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span><span class="s1">&#39;PType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">])</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Run the function</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_is_in_other_gal</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_other_gal_density_criterion_ptype"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_other_gal_density_criterion_ptype">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_is_in_other_gal_density_criterion_ptype</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test we can identify when a particle is in another galaxy, including some minimum density criterion for gas.</span>
<span class="sd">        Also make sure that PType is considered.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Change parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">min_gal_density</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="c1"># Setup Test Data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span> <span class="o">=</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">(</span> <span class="n">default_kwargs</span><span class="p">[</span><span class="s1">&#39;halo_data_dir&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span><span class="o">.</span><span class="n">get_mtree_halos</span><span class="p">(</span> <span class="s1">&#39;snum&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span><span class="s1">&#39;Den&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span><span class="s1">&#39;PType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">])</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Run the function</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_is_in_other_gal</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_main_gal"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_main_gal">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_is_in_main_gal</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Run the function</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_is_in_main_gal</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_main_gal_density_criterion"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_is_in_main_gal_density_criterion">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_is_in_main_gal_density_criterion</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can identify when a particle is in the main galaxy, including a density criterion.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Change paramters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">min_gal_density</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="c1"># Test data setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span><span class="s1">&#39;Den&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span><span class="p">[</span><span class="s1">&#39;PType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
        <span class="p">])</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Run the function</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_is_in_main_gal</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>


    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_calc_gal_event_id"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_calc_gal_event_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_calc_gal_event_id</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_main_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">expected_gal_event_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span>

        <span class="c1"># Run the function</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">calc_gal_event_id</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected_gal_event_id</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">#########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_accretion"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_accretion">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_accretion</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Get the prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">gal_event_id</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span>

        <span class="c1"># Run the function</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_accretion</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_ejection"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_ejection">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_ejection</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span> <span class="o">=</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">(</span> <span class="n">default_kwargs</span><span class="p">[</span><span class="s1">&#39;halo_data_dir&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span><span class="o">.</span><span class="n">get_mtree_halos</span><span class="p">(</span> <span class="s1">&#39;snum&#39;</span> <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Get the prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">gal_event_id</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span>

        <span class="c1"># Run the function</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_ejection</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_get_cum_num_acc"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_get_cum_num_acc">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_cum_num_acc</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_accreted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Accreted twice</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_cum_num_acc</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Accreted twice</span>
            <span class="p">])</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_get_redshift_first_acc"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_get_redshift_first_acc">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_redshift_first_acc</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_before_first_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Never accreted</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.06984665</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="p">])</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_redshift_first_acc</span><span class="p">()</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_ind_first_acc"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_ind_first_acc">[docs]</a>    <span class="k">def</span> <span class="nf">test_ind_first_acc</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_before_first_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Never accreted</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">99999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">99999</span> <span class="p">])</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ind_first_acc</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_is_before_first_acc"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_is_before_first_acc">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_is_before_first_acc</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">cum_num_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_main_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_is_before_first_acc</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_get_cumulative_time_in_other_gal"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_get_cumulative_time_in_other_gal">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_cumulative_time_in_other_gal</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can correctly get the cumulative time spent in another galaxy.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Test Data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
              <span class="p">[</span>   <span class="mf">51.</span><span class="p">,</span>  <span class="mf">51.</span><span class="p">,</span>  <span class="mf">51.</span><span class="p">,</span>  <span class="mf">51.</span><span class="p">,</span> <span class="p">],</span>
              <span class="p">[</span>   <span class="mf">51.</span><span class="p">,</span>  <span class="mf">51.</span><span class="p">,</span>  <span class="mf">51.</span><span class="p">,</span>  <span class="mf">51.</span><span class="p">,</span> <span class="p">],</span>
              <span class="p">[</span>   <span class="mf">51.</span><span class="p">,</span>  <span class="mf">51.</span><span class="p">,</span>  <span class="mf">51.</span><span class="p">,</span>  <span class="mf">51.</span><span class="p">,</span> <span class="p">],</span>
          <span class="p">])</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">153</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_cumulative_time_in_other_gal</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_time_in_other_gal_before_acc"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_time_in_other_gal_before_acc">[docs]</a>    <span class="k">def</span> <span class="nf">test_time_in_other_gal_before_acc</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_time_difference</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_before_first_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Calculated using NED cosmology calculator</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mf">2.404</span><span class="p">,</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_time_in_other_gal_before_acc</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_get_time_in_other_gal_before_acc_during_interval"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_get_time_in_other_gal_before_acc_during_interval">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_time_in_other_gal_before_acc_during_interval</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Our interval is 200 Myr&#39;&#39;&#39;</span>

        <span class="c1"># Prerequisites</span>
        <span class="c1"># For this test we&#39;re not going to use the default data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">t_m</span> <span class="o">=</span> <span class="mf">150.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
              <span class="p">[</span>   <span class="mf">50.</span><span class="p">,</span>   <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span> <span class="p">],</span>
              <span class="p">[</span>   <span class="mf">50.</span><span class="p">,</span>   <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span> <span class="p">],</span>
              <span class="p">[</span>   <span class="mf">50.</span><span class="p">,</span>   <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span> <span class="p">],</span>
              <span class="p">[</span>   <span class="mf">50.</span><span class="p">,</span>   <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span> <span class="p">],</span>
              <span class="p">[</span>   <span class="mf">50.</span><span class="p">,</span>   <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span> <span class="p">],</span>
              <span class="p">[</span>   <span class="mf">50.</span><span class="p">,</span>   <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span>  <span class="mf">50.</span><span class="p">,</span> <span class="p">],</span>
              <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_before_first_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Another merger</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Mass transfer</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Another test</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Another merger</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Mass transfer</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Another test</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="c1"># Correct the number of snapshots, accordingly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_gal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mf">150.</span><span class="p">,</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="mf">50.</span><span class="p">,</span> <span class="c1"># Another merger</span>
            <span class="mf">50.</span><span class="p">,</span>    <span class="c1"># Mass transfer</span>
            <span class="mf">100.</span><span class="p">,</span>  <span class="c1"># Another test</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_time_in_other_gal_before_acc_during_interval</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span> <span class="p">)</span></div>

    <span class="c1">#########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_unaccreted"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_unaccreted">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_unaccreted</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_main_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Never accreted onto the main galaxy</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Never accreted</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_unaccreted</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_pristine"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_pristine">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_pristine</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_preprocessed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Never accreted</span>
            <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_unaccreted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Never accreted</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_pristine</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">#########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_preprocessed"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_preprocessed">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_preprocessed</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">time_in_other_gal_before_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mf">1e3</span><span class="p">,</span> <span class="c1"># Unaccreted</span>
            <span class="mf">2.404</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_main_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Never accreted onto the main galaxy</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_before_first_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Never accreted onto the main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_unaccreted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Never accreted</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Never accreted</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_preprocessed</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_hitherto_EP"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_hitherto_EP">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_hitherto_EP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can identify material classified as EP up until</span>
<span class="sd">        this point.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Test data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">cumulative_time_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">153</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">153</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_hitherto_EP</span><span class="p">()</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_hitherto_NEP"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_hitherto_NEP">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_hitherto_NEP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can identify material classified as NEP up until</span>
<span class="sd">        this point.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Test data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">cumulative_time_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">153</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">153</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_hitherto_NEP</span><span class="p">()</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_unaccreted_EP"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_unaccreted_EP">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_unaccreted_EP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can identiy unaccreted EP gas.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Test data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_unaccreted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_hitherto_EP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_unaccreted_EP</span><span class="p">()</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_unaccreted_NEP"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_unaccreted_NEP">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_unaccreted_NEP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can identiy unaccreted EP gas.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Test data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_unaccreted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_hitherto_NEP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_unaccreted_NEP</span><span class="p">()</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">#########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_mass_transfer"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_mass_transfer">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_mass_transfer</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_preprocessed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Mass transfer</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">time_in_other_gal_before_acc_during_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mf">300.</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mf">50.</span><span class="p">,</span>    <span class="c1"># Mass transfer</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Mass Transfer</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_mass_transfer</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">#########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_merger"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_merger">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_merger</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_preprocessed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Mass transfer</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">time_in_other_gal_before_acc_during_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mf">300.</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mf">50.</span><span class="p">,</span>    <span class="c1"># Mass transfer</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mf">0.</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Mass Transfer</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_merger</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div>

    <span class="c1">#########################################################################</span>

<div class="viewcode-block" id="TestIdentifyAccrectionEjectionAndMergers.test_identify_wind"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestIdentifyAccrectionEjectionAndMergers.test_identify_wind">[docs]</a>    <span class="k">def</span> <span class="nf">test_identify_wind</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_ejected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Another test case</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_ejected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Another test case</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_wind</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="p">)</span></div></div>

<span class="c1">########################################################################</span>
<span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestFullClassifierPipeline"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestFullClassifierPipeline">[docs]</a><span class="k">class</span> <span class="nc">TestFullClassifierPipeline</span><span class="p">(</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span> <span class="p">):</span>

<div class="viewcode-block" id="TestFullClassifierPipeline.setUp"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestFullClassifierPipeline.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c1"># Mock the code version so we don&#39;t repeatedly change test data</span>
        <span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="p">(</span> <span class="s1">&#39;galaxy_dive.utils.utilities.get_code_version&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span> <span class="n">patcher</span><span class="o">.</span><span class="n">stop</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mock_code_version</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classify</span><span class="o">.</span><span class="n">Classifier</span><span class="p">(</span> <span class="o">**</span><span class="n">default_kwargs</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span> <span class="o">=</span> <span class="s1">&#39;./tests/data/tracking_output/classifications_test_classify.hdf5&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events_savefile</span> <span class="o">=</span> <span class="s1">&#39;./tests/data/tracking_output/events_test_classify.hdf5&#39;</span>

        <span class="c1"># Because we&#39;re skipping this step, we need to make sure we&#39;re not tossing objects around</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptracks_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">galids_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">tag</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span> <span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s1">&#39;rm </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_savefile</span> <span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s1">&#39;rm </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_savefile</span> <span class="p">)</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestFullClassifierPipeline.tearDown"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestFullClassifierPipeline.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span> <span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s1">&#39;rm </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_savefile</span> <span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s1">&#39;rm </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_savefile</span> <span class="p">)</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestFullClassifierPipeline.test_save_classifications"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestFullClassifierPipeline.test_save_classifications">[docs]</a>    <span class="k">def</span> <span class="nf">test_save_classifications</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Give it filenames to save.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack_filename</span> <span class="o">=</span> <span class="s1">&#39;test_ptrack_filename&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">galfind_filename</span> <span class="o">=</span> <span class="s1">&#39;test_galfind_filename&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span> <span class="o">=</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">(</span> <span class="n">default_kwargs</span><span class="p">[</span><span class="s1">&#39;halo_data_dir&#39;</span><span class="p">]</span> <span class="p">)</span>

        <span class="c1"># Add some properties that we&#39;re not testing in this test.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_main_mt_halo_first_snap</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_ind_first_snap</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c1"># Prerequisites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_unaccreted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Mass Transfer</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_pristine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Mass Transfer</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_preprocessed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Mass Transfer</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_mass_transfer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Mass Transfer</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_merger</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>    <span class="c1"># Merger, except in early snapshots</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Mass Transfer</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># Always part of main galaxy</span>
            <span class="mi">0</span><span class="p">,</span>    <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Another test case</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_unaccreted_EP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_unaccreted_NEP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_hitherto_EP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_hitherto_NEP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">redshift_first_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.06984665</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="p">])</span>

        <span class="c1"># Remove the request for additional post-processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">pp_classifications_to_save</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Change values from defaults so that we save without issue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">halo_file_tag</span> <span class="o">=</span> <span class="s1">&#39;smooth&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">mtree_halos_index</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># The function itself.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">save_classifications</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">classifications_to_save</span> <span class="p">)</span>

        <span class="c1"># Try to load the data</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_pristine</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;is_pristine&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestFullClassifierPipeline.test_save_events"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestFullClassifierPipeline.test_save_events">[docs]</a>    <span class="k">def</span> <span class="nf">test_save_events</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_ejected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Another test case</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_accreted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Accreted twice</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_CGM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_main_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">gal_event_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Merger, except in early snapshots</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># Always part of main galaxy</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="c1"># CGM -&gt; main galaxy -&gt; CGM</span>
            <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">cumulative_time_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">153.</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mf">153.</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mf">102.</span><span class="p">,</span> <span class="mf">51.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">time_in_other_gal_before_acc_during_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">redshift_first_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">0.06984665</span><span class="p">,</span> <span class="mf">0.16946003</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_ind_first_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">99999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">99999</span> <span class="p">])</span>

        <span class="c1"># Change values so that we save without issue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">halo_file_tag</span> <span class="o">=</span> <span class="s1">&#39;smooth&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">mtree_halos_index</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">save_events</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">events_to_save</span> <span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_savefile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">event_type</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;is_ejected&#39;</span><span class="p">,</span> <span class="s1">&#39;is_in_other_gal&#39;</span><span class="p">,</span> <span class="s1">&#39;is_in_main_gal&#39;</span><span class="p">,</span> <span class="s1">&#39;redshift_first_acc&#39;</span><span class="p">,</span> <span class="p">]:</span>
            <span class="k">assert</span> <span class="n">event_type</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestFullClassifierPipeline.test_additional_postprocessing"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestFullClassifierPipeline.test_additional_postprocessing">[docs]</a>    <span class="k">def</span> <span class="nf">test_additional_postprocessing</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="c1"># Change arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">classifications_to_save</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;is_A&#39;</span><span class="p">,</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">pp_classifications_to_save</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;is_not_A&#39;</span><span class="p">,</span> <span class="p">]</span>

        <span class="c1"># Fake original data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span> <span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;main_mt_halo_id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Add some properties that we&#39;re not testing in this test.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_main_mt_halo_first_snap</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_ind_first_snap</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">halo_file_tag</span> <span class="o">=</span> <span class="s1">&#39;smooth&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">mtree_halos_index</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Usual event saving</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">save_classifications</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">classifications_to_save</span>
        <span class="p">)</span>

        <span class="c1"># Add an attribute to worldlines to test post-processing event saving</span>
        <span class="k">def</span> <span class="nf">calc_is_not_A</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_not_A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_A&#39;</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_not_A&#39;</span><span class="p">]</span>
        <span class="n">analyze_worldlines</span><span class="o">.</span><span class="n">Worldlines</span><span class="o">.</span><span class="n">calc_is_not_A</span> <span class="o">=</span> <span class="n">calc_is_not_A</span>

        <span class="c1"># Post-processing event saving</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">additional_postprocessing</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">pp_classifications_to_save</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Test results</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span> <span class="p">)</span>

        <span class="c1"># Fiducial</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_A</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;is_A&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="p">)</span>
        <span class="c1"># post-processing</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_A</span> <span class="p">),</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;is_not_A&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
        <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestFullClassifierPipeline.test_full_pipeline"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestFullClassifierPipeline.test_full_pipeline">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_pipeline</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can run the full pipeline from just the files.&#39;&#39;&#39;</span>

        <span class="c1"># Force the first valid snapshot to be snapshot 10, to ensure compatibility with</span>
        <span class="c1"># previous tests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_main_mt_halo_first_snap</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">classify_particles</span><span class="p">()</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">actual</span> <span class="o">=</span>  <span class="n">f</span><span class="p">[</span><span class="s1">&#39;is_pristine&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>

        <span class="c1"># Make sure that we&#39;ve saved our input arguments</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="c1"># We don&#39;t store None as None, but a string instead (because None doesn&#39;t save well in hdf5)</span>
            <span class="k">if</span> <span class="n">default_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span>

            <span class="k">elif</span> <span class="n">default_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">default_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div></div>

<span class="c1">########################################################################</span>
<span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestBoundaryConditions"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestBoundaryConditions">[docs]</a><span class="k">class</span> <span class="nc">TestBoundaryConditions</span><span class="p">(</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span> <span class="p">):</span>

<div class="viewcode-block" id="TestBoundaryConditions.setUp"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestBoundaryConditions.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classify</span><span class="o">.</span><span class="n">Classifier</span><span class="p">(</span> <span class="o">**</span><span class="n">default_kwargs</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestBoundaryConditions.test_main_mt_halo_first_snap"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestBoundaryConditions.test_main_mt_halo_first_snap">[docs]</a>    <span class="k">def</span> <span class="nf">test_main_mt_halo_first_snap</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can get out the first snapshot for which we have a merger tree for our main halo.&#39;&#39;&#39;</span>

        <span class="c1"># Loade the necessary data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">read_data_files</span><span class="p">()</span>

        <span class="c1"># Using the defaults for the classifier.</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">main_mt_halo_first_snap</span>

        <span class="c1"># Test that we got out what we should have.</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="mi">36</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestBoundaryConditions.test_main_mt_halo_first_snap_jump_insensitive"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestBoundaryConditions.test_main_mt_halo_first_snap_jump_insensitive">[docs]</a>    <span class="k">def</span> <span class="nf">test_main_mt_halo_first_snap_jump_insensitive</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can get out the first snapshot for which we have a merger tree</span>
<span class="sd">        for our main halo, even if we dip below the criteria values at a lower redshift.</span>
<span class="sd">        (As might happen when the merger tree struggles).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Load the necessary data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">read_data_files</span><span class="p">()</span>

        <span class="c1"># Create a fake merger tree as test data.</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">,</span> <span class="s1">&#39;mtree_halos&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span> <span class="k">as</span> <span class="n">mock_mtree_halos</span><span class="p">:</span>

            <span class="c1"># More setting up of the fake merger tree.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;n_star&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">5</span> <span class="p">]),</span>
                <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span> <span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;snum&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;snum&#39;</span>
            <span class="n">mock_mtree_halos</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
                <span class="mi">0</span> <span class="p">:</span> <span class="n">df</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Actual calculation.</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">main_mt_halo_first_snap</span>

            <span class="c1"># Test that we got out what we should have.</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="mi">300</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestBoundaryConditions.test_ind_first_snap"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestBoundaryConditions.test_ind_first_snap">[docs]</a>    <span class="k">def</span> <span class="nf">test_ind_first_snap</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can get out the indice, for a standard array in the Classifier,</span>
<span class="sd">        at which the main merger tree halo is first resolved.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Setup test data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_main_mt_halo_first_snap</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span>  <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">]</span> <span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Get the actual value</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ind_first_snap</span>

        <span class="c1"># Compare to expected</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestBoundaryConditions.test_ind_first_snap_when_first_snap_skipped"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestBoundaryConditions.test_ind_first_snap_when_first_snap_skipped">[docs]</a>    <span class="k">def</span> <span class="nf">test_ind_first_snap_when_first_snap_skipped</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This test addresses Issue #57, i.e. Classifier.ind_first_snap fails if</span>
<span class="sd">        Classifier.main_mt_halo_first_snap is not in the tracked snapshots.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Setup test data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_main_mt_halo_first_snap</span> <span class="o">=</span> <span class="mi">592</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span>  <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">597</span><span class="p">,</span> <span class="mi">594</span><span class="p">,</span> <span class="mi">591</span><span class="p">,</span> <span class="p">]</span> <span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Get the actual value</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ind_first_snap</span>

        <span class="c1"># Compare to expected</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestBoundaryConditions.test_is_in_main_gal_bc"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestBoundaryConditions.test_is_in_main_gal_bc">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_in_main_gal_bc</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we don&#39;t allow anything to be inside the main galaxy</span>
<span class="sd">        before it is resolved.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Setup the test data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span> <span class="o">=</span> <span class="n">default_ptrack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack_attrs</span> <span class="o">=</span> <span class="n">default_ptrack_attrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_main_mt_halo_first_snap</span> <span class="o">=</span> <span class="mi">510</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_other_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_snap</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="c1"># Get the actual result out</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_is_in_main_gal</span><span class="p">()</span>

        <span class="c1"># Test that we got out what we should have.</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestBoundaryConditions.test_ind_first_acc"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestBoundaryConditions.test_ind_first_acc">[docs]</a>    <span class="k">def</span> <span class="nf">test_ind_first_acc</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we correctly identify the indice of first accretion, with the boundary</span>
<span class="sd">        conditions in place.</span>
<span class="sd">        This also tests everything that leads up to it.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Setup the test data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span> <span class="o">=</span> <span class="n">default_ptrack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack_attrs</span> <span class="o">=</span> <span class="n">default_ptrack_attrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_main_mt_halo_first_snap</span> <span class="o">=</span> <span class="mi">510</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_in_main_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_snap</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># Get the actual result out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">gal_event_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">calc_gal_event_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_accreted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_accretion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">cum_num_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_cum_num_acc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_before_first_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_is_before_first_acc</span><span class="p">()</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ind_first_acc</span>

        <span class="c1"># Test that we got out what we should have.</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">])</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestBoundaryConditions.test_is_not_preprocessed_bc"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestBoundaryConditions.test_is_not_preprocessed_bc">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_not_preprocessed_bc</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that anything that &quot;accretes&quot; onto the main galaxy at the first `neg` snapshots</span>
<span class="sd">        it&#39;s resolved is *not* counted as preprocessed.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Setup test data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">time_in_other_gal_before_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">200.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">,</span> <span class="mf">200.</span><span class="p">,</span> <span class="mf">200.</span><span class="p">,</span> <span class="mf">200.</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_ind_first_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">_ind_first_snap</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_snap</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">n_particle</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">neg</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">is_unaccreted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Get the actual calculation out</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">identify_preprocessed</span><span class="p">()</span>

        <span class="c1"># Test that we got out what we should have.</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span> <span class="p">])</span>
        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div></div>


<span class="c1">########################################################################</span>
<span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestVelocityScale"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestVelocityScale">[docs]</a><span class="k">class</span> <span class="nc">TestVelocityScale</span><span class="p">(</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Test that we can implement a veocity scale independently.&#39;&#39;&#39;</span>

<div class="viewcode-block" id="TestVelocityScale.setUp"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestVelocityScale.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classify</span><span class="o">.</span><span class="n">Classifier</span><span class="p">(</span> <span class="o">**</span><span class="n">default_kwargs</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestVelocityScale.test_get_velocity_scale_v_circ"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestVelocityScale.test_get_velocity_scale_v_circ">[docs]</a>    <span class="nd">@patch</span><span class="p">(</span> <span class="s1">&#39;linefinder.classify.Classifier.get_circular_velocity&#39;</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_get_velocity_scale_v_circ</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">mock_get_v_circ</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can still access the old way of getting the velocity scale</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="p">])</span>
        <span class="n">mock_get_v_circ</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span> <span class="n">expected</span><span class="p">,</span> <span class="p">]</span>

        <span class="c1"># Change one of the input parameters, because v_circ(halo) won&#39;t be the default.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">velocity_scale</span> <span class="o">=</span> <span class="s1">&#39;Vc(Rvir)&#39;</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_velocity_scale</span><span class="p">()</span>

        <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestVelocityScale.test_get_velocity_scale_specified"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestVelocityScale.test_get_velocity_scale_specified">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_velocity_scale_specified</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can pull the velocity scale straight from our halo finder files.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Create a fake merger tree as test data.</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">,</span> <span class="s1">&#39;mtree_halos&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span> <span class="k">as</span> <span class="n">mock_mtree_halos</span><span class="p">:</span>

            <span class="c1"># More setting up of the fake merger tree.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="p">]),</span>
                <span class="s1">&#39;Vc(3.0Rstar0.5)&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;snum&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;snum&#39;</span>
            <span class="n">mock_mtree_halos</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
                <span class="mi">0</span> <span class="p">:</span> <span class="n">df</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Setup mock particle track data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="p">]),</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack_attrs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;main_mt_halo_id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Change one of the input parameters to match what we want to pass it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">velocity_scale</span> <span class="o">=</span> <span class="s1">&#39;Vc(3.0Rstar0.5)&#39;</span>

            <span class="c1"># Load necessary data structures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span> <span class="o">=</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">halo_data_dir</span> <span class="p">)</span>

            <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_velocity_scale</span><span class="p">()</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="p">])</span>

            <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="TestVelocityScale.test_get_velocity_scale_r_gal"><a class="viewcode-back" href="../../../linefinder.tests.test_classify.html#linefinder.tests.test_classify.TestVelocityScale.test_get_velocity_scale_r_gal">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_velocity_scale_r_gal</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Test that we can pull the velocity scale from our halo finder files,</span>
<span class="sd">        finding what Rgal is automatically</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Create a fake merger tree as test data.</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">,</span> <span class="s1">&#39;mtree_halos&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span> <span class="k">as</span> <span class="n">mock_mtree_halos</span><span class="p">:</span>

            <span class="c1"># More setting up of the fake merger tree.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="p">]),</span>
                <span class="s1">&#39;Vc(3.0Rstar0.5)&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;snum&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;snum&#39;</span>
            <span class="n">mock_mtree_halos</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
                <span class="mi">0</span> <span class="p">:</span> <span class="n">df</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Setup mock particle track data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="p">]),</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ptrack_attrs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;galaxy_cut&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                <span class="s1">&#39;length_scale&#39;</span><span class="p">:</span> <span class="s1">&#39;Rstar0.5&#39;</span><span class="p">,</span>
                <span class="s1">&#39;main_mt_halo_id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Change our input parameter for what velocity scale we want to select</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">velocity_scale</span> <span class="o">=</span> <span class="s1">&#39;Vc(Rgal)&#39;</span>

            <span class="c1"># Load necessary data structures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">ahf_reader</span> <span class="o">=</span> <span class="n">read_ahf</span><span class="o">.</span><span class="n">AHFReader</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">halo_data_dir</span> <span class="p">)</span>

            <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">get_velocity_scale</span><span class="p">()</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="p">])</span>

            <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="p">)</span></div></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">linefinder 0.9.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Zachary Hafen.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
    </div>
  </body>
</html>