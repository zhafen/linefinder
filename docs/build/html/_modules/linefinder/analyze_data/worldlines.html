
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>linefinder.analyze_data.worldlines &#8212; linefinder 0.8.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for linefinder.analyze_data.worldlines</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&#39;&#39;&#39;Tools for reading worldline data</span>

<span class="sd">@author: Zach Hafen</span>
<span class="sd">@contact: zachary.h.hafen@gmail.com</span>
<span class="sd">@status: Development</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.testing</span> <span class="k">as</span> <span class="nn">npt</span>

<span class="kn">import</span> <span class="nn">galaxy_dive.analyze_data.ahf</span> <span class="k">as</span> <span class="nn">analyze_ahf_data</span>
<span class="kn">import</span> <span class="nn">galaxy_dive.analyze_data.generic_data</span> <span class="k">as</span> <span class="nn">generic_data</span>
<span class="kn">import</span> <span class="nn">galaxy_dive.analyze_data.simulation_data</span> <span class="k">as</span> <span class="nn">simulation_data</span>
<span class="kn">import</span> <span class="nn">galaxy_dive.read_data.snapshot</span> <span class="k">as</span> <span class="nn">read_snapshot</span>
<span class="kn">import</span> <span class="nn">galaxy_dive.utils.astro</span> <span class="k">as</span> <span class="nn">astro_tools</span>
<span class="kn">import</span> <span class="nn">galaxy_dive.utils.utilities</span> <span class="k">as</span> <span class="nn">utilities</span>

<span class="kn">import</span> <span class="nn">ids</span>
<span class="kn">import</span> <span class="nn">ptracks</span>
<span class="kn">import</span> <span class="nn">galids</span>
<span class="kn">import</span> <span class="nn">classifications</span>
<span class="kn">import</span> <span class="nn">events</span>

<span class="kn">import</span> <span class="nn">linefinder.utils.presentation_constants</span> <span class="k">as</span> <span class="nn">p_constants</span>
<span class="kn">import</span> <span class="nn">linefinder.config</span> <span class="k">as</span> <span class="nn">config</span>

<span class="c1">########################################################################</span>
<span class="c1">########################################################################</span>


<div class="viewcode-block" id="Worldlines"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines">[docs]</a><span class="k">class</span> <span class="nc">Worldlines</span><span class="p">(</span> <span class="n">simulation_data</span><span class="o">.</span><span class="n">TimeData</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wrapper for analysis of all data products. It loads data in</span>
<span class="sd">    on-demand.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_dir (str):</span>
<span class="sd">                Data directory for the classified data</span>

<span class="sd">            tag (str):</span>
<span class="sd">                Identifying tag for the data to load.</span>

<span class="sd">            ids_tag (str):</span>
<span class="sd">                Identifying tag for ids data. Defaults to tag.</span>

<span class="sd">            ptracks_tag (str):</span>
<span class="sd">                Identifying tag for ptracks data. Defaults to tag.</span>

<span class="sd">            galids_tag (str):</span>
<span class="sd">                Identifying tag for galids data. Defaults to tag.</span>

<span class="sd">            classifications_tag (str):</span>
<span class="sd">                Identifying tag for classifications data. Defaults to tag.</span>

<span class="sd">            events_tag (str):</span>
<span class="sd">                Identifying tag for events data. Defaults to tag.</span>

<span class="sd">            label (str):</span>
<span class="sd">                Identifying label for the worldlines, used for plotting.</span>
<span class="sd">                Defaults to tag.</span>

<span class="sd">            color (str):</span>
<span class="sd">                What color to use when plotting.</span>
<span class="sd">        &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">,</span>
        <span class="n">ids_tag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ptracks_tag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">galids_tag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">classifications_tag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">events_tag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="n">ids_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ids_tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">if</span> <span class="n">ptracks_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ptracks_tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">if</span> <span class="n">galids_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">galids_tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">if</span> <span class="n">classifications_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">classifications_tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">if</span> <span class="n">events_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">events_tag</span> <span class="o">=</span> <span class="n">tag</span>

        <span class="c1"># Store the arguments</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">arg</span><span class="p">]</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ptracks_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="n">kwargs</span> <span class="p">)</span>

        <span class="n">data_masker</span> <span class="o">=</span> <span class="n">WorldlineDataMasker</span><span class="p">(</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="n">key_parser</span> <span class="o">=</span> <span class="n">WorldlineDataKeyParser</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">super</span><span class="p">(</span> <span class="n">Worldlines</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">data_masker</span><span class="o">=</span><span class="n">data_masker</span><span class="p">,</span> <span class="n">key_parser</span><span class="o">=</span><span class="n">key_parser</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

    <span class="c1">########################################################################</span>
    <span class="c1"># Properties for loading data on the fly</span>
    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ids</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_ids&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">IDs</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids_tag</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span>

    <span class="nd">@ids</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">ids</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ptracks</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_ptracks&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ptracks</span> <span class="o">=</span> <span class="n">ptracks</span><span class="o">.</span><span class="n">PTracks</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks_tag</span><span class="p">,</span> <span class="n">store_ahf_reader</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">ptracks_kwargs</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptracks</span>

    <span class="nd">@ptracks</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">ptracks</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptracks</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">galids</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_galids&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_galids</span> <span class="o">=</span> <span class="n">galids</span><span class="o">.</span><span class="n">GalIDs</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids_tag</span> <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_galids</span>

    <span class="nd">@galids</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">galids</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_galids</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">classifications</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_classifications&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_classifications</span> <span class="o">=</span> <span class="n">classifications</span><span class="o">.</span><span class="n">Classifications</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifications_tag</span> <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifications</span>

    <span class="nd">@classifications</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">classifications</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifications</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_events&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">Events</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_tag</span> <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span>

    <span class="nd">@events</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">halo_data</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Halo Data.</span>

<span class="sd">        TODO:</span>
<span class="sd">            Make it easier to get the parameters to use, without loading as</span>
<span class="sd">            much superfluous data.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_halo_data&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_halo_data</span> <span class="o">=</span> <span class="n">analyze_ahf_data</span><span class="o">.</span><span class="n">HaloData</span><span class="p">(</span>
                <span class="n">data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_data_dir</span><span class="p">,</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;halo_file_tag&#39;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halo_data</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_data_shape</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">base_data_shape</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">length_scale</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">length_scale</span><span class="o">.</span><span class="n">values</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_snaps</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Number of snapshots, i.e. data points on the time axis.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_n_snaps&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_snaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">base_data_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_snaps</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_particles</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The number of particles tracked.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_n_particles&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">base_data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_particles</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_particles_presampled</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The number of particles selected, prior to sampling.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_n_particles_presampled&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_particles_presampled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">data_attrs</span><span class="p">[</span><span class="s1">&#39;n_particles&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_particles_presampled</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_particles_snapshot</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The number of star and gas particles in the last snapshot tracked. Should be the same throughout the simulation,</span>
<span class="sd">        if there&#39;s conservation of star and gas particles.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles_snapshot_gas</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles_snapshot_star</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_particles_snapshot_gas</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The number of gas particles in the last snapshot tracked.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_n_particles_snapshot_gas&#39;</span> <span class="p">):</span>

            <span class="n">snapshot_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;sdir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">snapshot_parameters</span><span class="p">[</span><span class="s1">&#39;sdir&#39;</span><span class="p">],</span>
                <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;snum_end&#39;</span><span class="p">],</span>
                <span class="s1">&#39;ptype&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">PTYPE_GAS</span><span class="p">,</span>
                <span class="s1">&#39;header_only&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">read_snapshot</span><span class="o">.</span><span class="n">readsnap</span><span class="p">(</span> <span class="o">**</span><span class="n">snapshot_kwargs</span> <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_n_particles_snapshot_gas</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">[</span><span class="s1">&#39;npart&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_particles_snapshot_gas</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_particles_snapshot_star</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The number of star particles in the last snapshot tracked.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_n_particles_snapshot_star&#39;</span> <span class="p">):</span>

            <span class="n">snapshot_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;sdir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">snapshot_parameters</span><span class="p">[</span><span class="s1">&#39;sdir&#39;</span><span class="p">],</span>
                <span class="s1">&#39;snum&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;snum_end&#39;</span><span class="p">],</span>
                <span class="s1">&#39;ptype&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">PTYPE_STAR</span><span class="p">,</span>
                <span class="s1">&#39;header_only&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">read_snapshot</span><span class="o">.</span><span class="n">readsnap</span><span class="p">(</span> <span class="o">**</span><span class="n">snapshot_kwargs</span> <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_n_particles_snapshot_star</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">[</span><span class="s1">&#39;npart&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_particles_snapshot_star</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">redshift</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_redshift&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">redshift</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redshift</span>

    <span class="nd">@redshift</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">redshift</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Setting function for simulation redshift property.&#39;&#39;&#39;</span>

        <span class="c1"># If we try to set it, make sure that if it already exists we don&#39;t change it.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_redshift&#39;</span> <span class="p">):</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redshift</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="p">):</span>

                <span class="n">is_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span> <span class="n">value</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redshift</span> <span class="p">)</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
                <span class="n">not_nan_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="n">is_nan</span> <span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">test_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)[</span><span class="n">not_nan_inds</span><span class="p">]</span>  <span class="c1"># Cast as np.ndarray because Pandas arrays can cause trouble.</span>
                <span class="n">test_existing_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_redshift</span><span class="p">)[</span><span class="n">not_nan_inds</span><span class="p">]</span>
                <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">test_value</span><span class="p">,</span> <span class="n">test_existing_value</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span> <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_redshift</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redshift</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span> <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_redshift</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">r_gal</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_r_gal&#39;</span> <span class="p">):</span>
            <span class="n">length_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mt_length_scale&#39;</span><span class="p">]</span>
            <span class="n">galaxy_cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;galaxy_cut&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_r_gal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_data</span><span class="o">.</span><span class="n">get_mt_data</span><span class="p">(</span>
                <span class="n">length_scale</span><span class="p">,</span>
                <span class="n">a_power</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">galaxy_cut</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">data_attrs</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_gal</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inner_CGM_boundary</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_inner_CGM_boundary&#39;</span> <span class="p">):</span>

            <span class="c1"># Get the inner CGM radius as construed by the galaxy radius</span>
            <span class="n">inner_r_gal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_snaps</span> <span class="p">)</span>
            <span class="n">inner_r_gal_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_gal</span> <span class="o">*</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">F_GAP</span> <span class="p">)</span> 
            <span class="n">inner_r_gal</span><span class="p">[:</span><span class="n">inner_r_gal_part</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">inner_r_gal_part</span>

            <span class="c1"># Get the inner CGM radius as construed by the virial radisu</span>
            <span class="n">inner_r_vir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">INNER_CGM_BOUNDARY</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_vir</span> <span class="p">)</span>

            <span class="c1"># Maximize the two</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inner_CGM_boundary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="p">[</span> <span class="n">inner_r_gal</span><span class="p">,</span> <span class="n">inner_r_vir</span> <span class="p">],</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner_CGM_boundary</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outer_CGM_boundary</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_outer_CGM_boundary&#39;</span> <span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_outer_CGM_boundary</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">OUTER_CGM_BOUNDARY</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_vir</span> <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outer_CGM_boundary</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">snums</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">snums</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hubble_param</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">data_attrs</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">m_tot</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Total mass at the last snapshot.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_m_tot&#39;</span> <span class="p">):</span>
            <span class="n">masses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span> <span class="p">)</span>
            <span class="n">masses_no_invalids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">fix_invalid</span><span class="p">(</span> <span class="n">masses</span> <span class="p">)</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_m_tot</span> <span class="o">=</span> <span class="n">masses_no_invalids</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m_tot</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">conversion_factor</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The ratio necessary to convert to the total mass from the sample mass.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_conversion_factor&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conversion_factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles_presampled</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conversion_factor</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mass_totals</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the total mass in the sample in the last snapshot in the canonical classifications.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_mass_totals&#39;</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass_totals</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">mass_category</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;is_pristine&#39;</span><span class="p">,</span> <span class="s1">&#39;is_merger&#39;</span><span class="p">,</span> <span class="s1">&#39;is_mass_transfer&#39;</span><span class="p">,</span> <span class="s1">&#39;is_wind&#39;</span> <span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mass_totals</span><span class="p">[</span><span class="n">mass_category</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_data</span><span class="p">(</span>
                    <span class="s1">&#39;M&#39;</span><span class="p">,</span>
                    <span class="n">sl</span><span class="o">=</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">classification</span><span class="o">=</span><span class="n">mass_category</span><span class="p">,</span>
                    <span class="n">fix_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_mass_totals</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">SmartDict</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_totals</span> <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_totals</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mass_fractions</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the mass fraction in the last snapshot in the canonical classifications.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_totals</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_tot</span>

    <span class="c1">########################################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">real_mass_totals</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the total mass (converted from the sample) in the last snapshot</span>
<span class="sd">        in the canonical classifications.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_totals</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion_factor</span>

    <span class="c1">########################################################################</span>
    <span class="c1"># Top Level Functions</span>
    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.clear_data"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.clear_data">[docs]</a>    <span class="k">def</span> <span class="nf">clear_data</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Clear all loaded data.&#39;&#39;&#39;</span>

        <span class="n">data_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;ids&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ptracks&#39;</span><span class="p">,</span>
            <span class="s1">&#39;galids&#39;</span><span class="p">,</span>
            <span class="s1">&#39;classifications&#39;</span><span class="p">,</span>
            <span class="s1">&#39;events&#39;</span>
        <span class="p">]</span>
    
        <span class="k">for</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">data_types</span><span class="p">:</span>

            <span class="n">data_attr</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">data_type</span> <span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data_attr</span> <span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data_attr</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.get_parameters"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="s1">&#39;ptracks&#39;</span><span class="p">,</span> <span class="s1">&#39;galids&#39;</span><span class="p">,</span> <span class="s1">&#39;classifications&#39;</span> <span class="p">]:</span>

            <span class="n">parameters</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">)</span><span class="o">.</span><span class="n">parameters</span>

        <span class="k">return</span> <span class="n">parameters</span></div>

    <span class="c1">########################################################################</span>
    <span class="c1"># Get Data</span>
    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.get_data"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get data. Usually just get it from ptracks. args and kwargs are passed to self.ptracks.get_data()</span>

<span class="sd">        Args:</span>
<span class="sd">            data_key (str) : What data to get?</span>
<span class="sd">            *args, **kwargs : Additional arguments to pass to other get_data() methods.</span>

<span class="sd">        Returns:</span>
<span class="sd">            data (np.ndarray) : Array of data.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># First, look to see if this data is calculated in some easy to access location</span>
        <span class="k">if</span> <span class="n">data_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span>

            <span class="c1"># Apply the slice if that needs to be done.</span>
            <span class="k">if</span> <span class="s1">&#39;sl&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sl&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sl&#39;</span><span class="p">]]</span>

            <span class="k">return</span> <span class="n">data</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span> <span class="n">Worldlines</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">data_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># A lot of the data can be calculated from the particle tracks data, so we can also try to access it from there.</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">data_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># TODO: Fix the structure s.t. it&#39;s improved from this.</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">data_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.get_processed_data"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_processed_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_processed_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_key</span><span class="p">,</span>
        <span class="n">tile_data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get data, handling more complex data keys that indicate doing generic</span>
<span class="sd">        things to the data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_key (str) :</span>
<span class="sd">                What data to get?</span>

<span class="sd">            sl (object) :</span>
<span class="sd">                How to slice the data before returning it.</span>

<span class="sd">            tile_data (bool) :</span>
<span class="sd">                If True, tile data along a given direction. This is usually for</span>
<span class="sd">                data formatting purposes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            data (np.ndarray) : Array of data.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">data_key</span><span class="p">,</span> <span class="n">tiled_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_parser</span><span class="o">.</span><span class="n">is_tiled_key</span><span class="p">(</span> <span class="n">data_key</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">tiled_flag</span><span class="p">:</span>
            <span class="n">tile_data</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span> <span class="n">Worldlines</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span><span class="o">.</span><span class="n">get_processed_data</span><span class="p">(</span>
            <span class="n">data_key</span><span class="p">,</span>
            <span class="n">tile_data</span> <span class="o">=</span> <span class="n">tile_data</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.get_data_at_ind"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_data_at_ind">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_at_ind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_key</span><span class="p">,</span>
        <span class="n">ind_key</span><span class="p">,</span>
        <span class="n">ind_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">units_a_power</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
        <span class="n">units_h_power</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
        <span class="n">return_units_only</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">tile_data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the data at a specified index for each particle.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_key (str) : What data to get?</span>
<span class="sd">            ind_key (str) : What index to use?</span>
<span class="sd">            ind_shift (int) : Relative to the index identified by ind_key, how should the index be shifted?</span>
<span class="sd">            units (str) : If given, scale the data by this value, taken from the halo data.</span>
<span class="sd">            units_a_power (float) : If using units from the halo data, multiply by a to this power to convert.</span>
<span class="sd">            units_h_power (float) : If using units from the halo data, multiply by the hubble param to this power to convert.</span>
<span class="sd">            return_units_only (bool) : Return just the units argument. Useful for debugging.</span>
<span class="sd">            tile_data (bool) : If True, tile data before getting the data at a specific index.</span>
<span class="sd">            *args, **kwargs : Arguments to be passed to self.get_data()</span>

<span class="sd">        Returns:</span>
<span class="sd">            data_at_ind (np.ndarray) : Array of data, at the specified index.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">data_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">tile_data</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_snaps</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_snaps</span><span class="p">,</span> <span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Unrecognized data shape, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span> <span class="p">):</span>
            <span class="n">fill_value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">INT_FILL_VALUE</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span> <span class="p">)</span> <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">):</span>
            <span class="n">fill_value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">FLOAT_FILL_VALUE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Unrecognized data type, data.dtype = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">data_at_ind</span> <span class="o">=</span> <span class="n">fill_value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="p">)</span>

        <span class="n">specified_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">ind_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

        <span class="c1"># Look only at indices we retrieved successfully</span>
        <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">specified_ind</span> <span class="o">!=</span> <span class="n">config</span><span class="o">.</span><span class="n">INT_FILL_VALUE</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">valid_specified_ind</span> <span class="o">=</span> <span class="n">specified_ind</span><span class="p">[</span><span class="n">valid_inds</span><span class="p">]</span>

        <span class="c1"># Shift the indices by the specified amount, if desired</span>
        <span class="n">valid_specified_ind</span> <span class="o">+=</span> <span class="n">ind_shift</span>

        <span class="n">data_at_ind</span><span class="p">[</span><span class="n">valid_inds</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">valid_inds</span><span class="p">,</span> <span class="n">valid_specified_ind</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Get the units out</span>
            <span class="n">units_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_data</span><span class="o">.</span><span class="n">get_mt_data</span><span class="p">(</span>
                <span class="n">units</span><span class="p">,</span>
                <span class="n">mt_halo_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;main_mt_halo_id&#39;</span><span class="p">],</span>
                <span class="n">a_power</span> <span class="o">=</span> <span class="n">units_a_power</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Get the right indices out</span>
            <span class="n">units_arr_at_ind</span> <span class="o">=</span> <span class="n">units_arr</span><span class="p">[</span><span class="n">valid_specified_ind</span><span class="p">]</span>

            <span class="c1"># Include any factors of h</span>
            <span class="n">units_arr_at_ind</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">data_attrs</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">units_h_power</span>

            <span class="k">if</span> <span class="n">return_units_only</span><span class="p">:</span>
                <span class="n">units_arr_all</span> <span class="o">=</span> <span class="n">fill_value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="p">)</span>
                <span class="n">units_arr_all</span><span class="p">[</span><span class="n">valid_inds</span><span class="p">]</span> <span class="o">=</span> <span class="n">units_arr_at_ind</span>

                <span class="k">return</span> <span class="n">units_arr_all</span>

            <span class="n">data_at_ind</span><span class="p">[</span><span class="n">valid_inds</span><span class="p">]</span> <span class="o">/=</span> <span class="n">units_arr_at_ind</span>

        <span class="k">return</span> <span class="n">data_at_ind</span></div>

<div class="viewcode-block" id="Worldlines.get_data_first_acc"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_data_first_acc">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_first_acc</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">ind_after_first_acc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ind_relative_to_first_acc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get data the snapshot immediately before accretion.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_key (str) : What data to get?</span>
<span class="sd">            ind_after_first_acc (bool) : If True, get data the index immediately *after* first accretion, instead.</span>
<span class="sd">            ind_relative_to_first_acc (int) : Move the snapshot index relative to the snapshot before first accretion.</span>
<span class="sd">            *args, **kwargs : Arguments to be passed to self.get_data_at_ind()</span>

<span class="sd">        Returns:</span>
<span class="sd">            data_first_acc (np.ndarray) : Array of data, the index immediately after first accretion.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span> <span class="n">ind_after_first_acc</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">ind_relative_to_first_acc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">),</span> <span class="s2">&quot;Choose one option.&quot;</span>

        <span class="c1"># ind_first_acc is defined as the index at which a particle is first found in a galaxy,</span>
        <span class="c1"># so we need to shift things around accordingly</span>
        <span class="k">if</span> <span class="n">ind_after_first_acc</span><span class="p">:</span>
            <span class="n">ind_shift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind_shift</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ind_relative_to_first_acc</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_at_ind</span><span class="p">(</span> <span class="n">data_key</span><span class="p">,</span> <span class="s1">&#39;ind_first_acc&#39;</span><span class="p">,</span> <span class="n">ind_shift</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Worldlines.get_data_ind_star"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_data_ind_star">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_ind_star</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get data at the snapshot a particle is first identified as a star.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_key (str) : What data to get?</span>
<span class="sd">            *args, **kwargs : Arguments to be passed to self.get_data_at_ind()</span>

<span class="sd">        Returns:</span>
<span class="sd">            data_ind_star (np.ndarray) : Array of data, at the index a particle is first identified as a star.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_at_ind</span><span class="p">(</span> <span class="n">data_key</span><span class="p">,</span> <span class="s1">&#39;ind_star&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.get_fraction_outside"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_fraction_outside">[docs]</a>    <span class="k">def</span> <span class="nf">get_fraction_outside</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">data_min</span><span class="p">,</span> <span class="n">data_max</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the fraction of data outside a certain range. *args, **kwargs are arguments sent to mask the data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_key (str) : What data to get.</span>
<span class="sd">            data_min (float) : Lower bound of the data range.</span>
<span class="sd">            data_max (float) : Upper bound of the data range.</span>

<span class="sd">        Returns:</span>
<span class="sd">            f_outside (float) : Fraction outside the range.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_data</span><span class="p">(</span> <span class="n">data_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

        <span class="n">data_ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_outside</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_min</span><span class="p">,</span> <span class="n">data_max</span> <span class="p">)</span>

        <span class="n">n_outside</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">data_ma</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">n_all</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">n_outside</span> <span class="o">/</span> <span class="n">n_all</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.get_selected_quantity"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_selected_quantity">[docs]</a>    <span class="k">def</span> <span class="nf">get_selected_quantity</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">selection_routine</span><span class="o">=</span><span class="s1">&#39;galaxy&#39;</span><span class="p">,</span>
            <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span>
            <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span>
            <span class="n">low_memory_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">selected_quantity_data_key</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Apply a selection routine, and then get out the total mass (or</span>
<span class="sd">        some other quantity) of particles that fulfill that criteria.</span>

<span class="sd">        Args:</span>

<span class="sd">            selection_routine (str) :</span>
<span class="sd">                What selection routine to run. E.g. &#39;galaxy&#39; selects all</span>
<span class="sd">                particles in the main galaxy.</span>

<span class="sd">            ptype (str):</span>
<span class="sd">                What particle type inside the galaxy to consider.</span>

<span class="sd">            quantity (str):</span>
<span class="sd">                What quantity of the galaxy to retrieve.</span>

<span class="sd">            low_memory_mode (bool):</span>
<span class="sd">                If True, unload the data after getting the quantity</span>
<span class="sd">                (saves memory at the cost of convenience).</span>

<span class="sd">            *args, **kwargs :</span>
<span class="sd">                Additional arguments to be passed to self.get_selected_data()</span>

<span class="sd">        Returns:</span>
<span class="sd">            selected_quantity (np.ndarray) :</span>
<span class="sd">                Total mass for a particular particle type in the main galaxy</span>
<span class="sd">                (satisfying any additional requirements passed via *args and **kwargs)</span>
<span class="sd">                at each specified redshift.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Run the selection routine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_masker</span><span class="o">.</span><span class="n">run_selection_routine</span><span class="p">(</span> <span class="n">selection_routine</span><span class="p">,</span> <span class="n">ptype</span> <span class="p">)</span>

        <span class="n">data_ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_data</span><span class="p">(</span>
            <span class="n">selected_quantity_data_key</span><span class="p">,</span>
            <span class="n">fix_invalid</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">compress</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Test for the case when everything is masked.</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="n">data_ma</span><span class="o">.</span><span class="n">mask</span> <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mf">0.</span>
            <span class="c1"># Case when nothing is masked.</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">selected_quantity</span> <span class="o">=</span> <span class="n">data_ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>

            <span class="c1"># Replace masked values with 0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">selected_quantity</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">selected_quantity</span> <span class="o">=</span> <span class="n">selected_quantity</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;n_particles&#39;</span><span class="p">:</span>
            <span class="n">selected_quantity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="n">data_ma</span><span class="o">.</span><span class="n">mask</span> <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Unrecognized selected_quantity, selected_quantity = </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">selected_quantity</span> <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">low_memory_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">selected_quantity</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.get_selected_quantity_radial_bins"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_selected_quantity_radial_bins">[docs]</a>    <span class="k">def</span> <span class="nf">get_selected_quantity_radial_bins</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selection_routine</span><span class="o">=</span><span class="s1">&#39;galaxy&#39;</span><span class="p">,</span>
        <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span>
        <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span>
        <span class="n">radial_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span> <span class="p">),</span>
        <span class="n">radial_bin_data_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;scale_key&#39;</span><span class="p">:</span> <span class="s1">&#39;Rvir&#39;</span><span class="p">,</span>
            <span class="s1">&#39;scale_a_power&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
            <span class="s1">&#39;scale_h_power&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">low_memory_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Apply a selection routine, and then get out the total mass (or</span>
<span class="sd">        some other quantity) of particles that fulfill that criteria,</span>
<span class="sd">        in specified radial bins.</span>

<span class="sd">        Args:</span>

<span class="sd">            selection_routine (str) :</span>
<span class="sd">                What selection routine to run. E.g. &#39;galaxy&#39; selects all</span>
<span class="sd">                particles in the main galaxy.</span>

<span class="sd">            ptype (str):</span>
<span class="sd">                What particle type inside the galaxy to consider.</span>

<span class="sd">            quantity (str):</span>
<span class="sd">                What quantity to retrieve.</span>

<span class="sd">            radial_bins (np.ndarray) :</span>
<span class="sd">                Radial bins to use.</span>

<span class="sd">            radial_bin_data_kwargs (dict) :</span>
<span class="sd">                Arguments to change how the data is masked. For example,</span>
<span class="sd">                if you want to scale the data (done by default), use this</span>
<span class="sd">                dictionary to do so. These are arguments that would be passed</span>
<span class="sd">                to self.data_masker.mask_data and in turn</span>
<span class="sd">                self.data_masker.get_processed_data.</span>

<span class="sd">            low_memory_mode (bool):</span>
<span class="sd">                If True, unload the data after getting the quantity</span>
<span class="sd">                (saves memory at the cost of convenience).</span>

<span class="sd">            *args, **kwargs :</span>
<span class="sd">                Additional arguments to be passed to self.get_selected_data()</span>

<span class="sd">        Returns:</span>
<span class="sd">            selected_quantity (np.ndarray) :</span>
<span class="sd">                Total mass for a particular particle type in the main galaxy</span>
<span class="sd">                (satisfying any additional requirements passed via *args and **kwargs)</span>
<span class="sd">                at each specified redshift.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Get a fresh start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_masker</span><span class="o">.</span><span class="n">clear_masks</span><span class="p">(</span> <span class="kc">True</span> <span class="p">)</span>

        <span class="c1"># Run the selection routine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_masker</span><span class="o">.</span><span class="n">run_selection_routine</span><span class="p">(</span> <span class="n">selection_routine</span><span class="p">,</span> <span class="n">ptype</span> <span class="p">)</span>

        <span class="c1"># Loop over each radial bin and get the results out</span>
        <span class="n">selected_quantity_radial_bins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">radial_bins</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span>

            <span class="n">r_in</span> <span class="o">=</span> <span class="n">radial_bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">r_out</span> <span class="o">=</span> <span class="n">radial_bins</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">radial_bin_mask_name</span> <span class="o">=</span> <span class="s1">&#39;R</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data_masker</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span>
                <span class="s1">&#39;R&#39;</span><span class="p">,</span>
                <span class="n">r_in</span><span class="p">,</span>
                <span class="n">r_out</span><span class="p">,</span>
                <span class="n">optional_mask</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">mask_name</span> <span class="o">=</span> <span class="n">radial_bin_mask_name</span><span class="p">,</span>
                <span class="o">**</span><span class="n">radial_bin_data_kwargs</span>
            <span class="p">)</span>

            <span class="n">data_ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_data</span><span class="p">(</span>
                <span class="s1">&#39;M&#39;</span><span class="p">,</span>
                <span class="n">fix_invalid</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">compress</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">optional_masks</span> <span class="o">=</span> <span class="p">[</span> <span class="n">radial_bin_mask_name</span> <span class="p">],</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>

                <span class="c1"># Test for the case when everything is masked.</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="n">data_ma</span><span class="o">.</span><span class="n">mask</span> <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">selected_quantity_radial_bins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mf">0.</span> <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">selected_quantity</span> <span class="o">=</span> <span class="n">data_ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>

                <span class="c1"># Replace masked values with 0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">selected_quantity</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">selected_quantity</span> <span class="o">=</span> <span class="n">selected_quantity</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>

                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">selected_quantity_radial_bins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">selected_quantity</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">low_memory_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">selected_quantity_radial_bins</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.get_categories_selected_quantity"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_categories_selected_quantity">[docs]</a>    <span class="k">def</span> <span class="nf">get_categories_selected_quantity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">classification_list</span> <span class="o">=</span> <span class="n">p_constants</span><span class="o">.</span><span class="n">CLASSIFICATIONS_A</span><span class="p">,</span>
        <span class="n">selected_quantity_method</span> <span class="o">=</span> <span class="s1">&#39;get_selected_quantity&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the total mass in the main galaxy for a particular particle type in each</span>
<span class="sd">        of a number of classification categories. This is only for particles that are tracked! This is not the real mass!</span>

<span class="sd">        Args:</span>
<span class="sd">            classification_list (list) :</span>
<span class="sd">                What classifications to use.</span>

<span class="sd">            selected_quantity_method (str) :</span>
<span class="sd">                Method to use for getting the selected quantity.</span>
<span class="sd">                For example, use &#39;get_selected_quantity_radial_bins&#39; if you</span>
<span class="sd">                want the selected quantity in, well, radial bins.</span>

<span class="sd">            *args, **kwargs :</span>
<span class="sd">                Additional arguments to be passed to self.get_selected_data()</span>

<span class="sd">        Returns:</span>
<span class="sd">            categories_selected_quantity (SmartDict of np.ndarrays) :</span>
<span class="sd">                selected_quantity that fits each classification.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">selected_quantity_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">selected_quantity_method</span> <span class="p">)</span>

        <span class="n">selected_quantity</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mass_category</span> <span class="ow">in</span> <span class="n">classification_list</span><span class="p">:</span>
            <span class="n">selected_quantity</span><span class="p">[</span><span class="n">mass_category</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_quantity_fn</span><span class="p">(</span>
                <span class="n">classification</span> <span class="o">=</span> <span class="n">mass_category</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">utilities</span><span class="o">.</span><span class="n">SmartDict</span><span class="p">(</span> <span class="n">selected_quantity</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Worldlines.get_categories_selected_quantity_fraction"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_categories_selected_quantity_fraction">[docs]</a>    <span class="k">def</span> <span class="nf">get_categories_selected_quantity_fraction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">normalization_category</span><span class="p">,</span>
        <span class="n">classification_list</span> <span class="o">=</span> <span class="n">p_constants</span><span class="o">.</span><span class="n">CLASSIFICATIONS_A</span><span class="p">,</span>
        <span class="n">selected_quantity_method</span> <span class="o">=</span> <span class="s1">&#39;get_selected_quantity&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Same as categories_selected_quantity, but as a fraction of the total</span>
<span class="sd">        mass in the main galaxy for a particular particle type.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">categories_selected_quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_categories_selected_quantity</span><span class="p">(</span>
            <span class="n">classification_list</span> <span class="o">=</span> <span class="n">classification_list</span><span class="p">,</span>
            <span class="n">selected_quantity_method</span> <span class="o">=</span> <span class="n">selected_quantity_method</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="n">selected_quantity_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">selected_quantity_method</span> <span class="p">)</span>

        <span class="n">normalization</span> <span class="o">=</span> <span class="n">selected_quantity_fn</span><span class="p">(</span>
            <span class="n">classification</span><span class="o">=</span><span class="n">normalization_category</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">categories_selected_quantity</span> <span class="o">/</span> <span class="n">normalization</span></div>

<div class="viewcode-block" id="Worldlines.get_categories_selected_quantity_extrapolated"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.get_categories_selected_quantity_extrapolated">[docs]</a>    <span class="k">def</span> <span class="nf">get_categories_selected_quantity_extrapolated</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">classification_list</span> <span class="o">=</span> <span class="n">p_constants</span><span class="o">.</span><span class="n">CLASSIFICATIONS_A</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the total mass in the main galaxy for a particular particle type in each</span>
<span class="sd">        of a number of classification categories.</span>

<span class="sd">        Args:</span>
<span class="sd">            classification_list (list) :</span>
<span class="sd">                What classifications to use.</span>

<span class="sd">            *args, **kwargs :</span>
<span class="sd">                Additional arguments to be passed to self.get_selected_data()</span>

<span class="sd">        Returns:</span>
<span class="sd">            categories_selected_quantity (SmartDict of np.ndarrays) :</span>
<span class="sd">                selected_quantity that fits each classification.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">categories_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_categories_selected_quantity</span><span class="p">(</span> <span class="n">classification_list</span><span class="o">=</span><span class="n">classification_list</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">categories_mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion_factor</span></div>

    <span class="c1">########################################################################</span>
    <span class="c1"># Generate Data on the Go</span>
    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.handle_data_key_error"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.handle_data_key_error">[docs]</a>    <span class="k">def</span> <span class="nf">handle_data_key_error</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data_key</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;If we don&#39;t have a data_key stored, try and create it.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_key (str) : The data key in question.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data (dict) : If successful, stores the data here.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span> <span class="n">Worldlines</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span><span class="o">.</span><span class="n">handle_data_key_error</span><span class="p">(</span> <span class="n">data_key</span> <span class="p">)</span>

        <span class="c1"># We do this second because it involves loading alot of data...</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifications</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifications</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">data_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">data_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_fresh_accretion"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_fresh_accretion">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_fresh_accretion</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find material classified as fresh accretion (pristine gas that has not recycled).</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;is_fresh_accretion&#39;] ( np.ndarray ) : Result.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">pristine_tiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_pristine&#39;</span> <span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_snaps</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">is_not_wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_wind&#39;</span> <span class="p">)</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_fresh_accretion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="p">[</span> <span class="n">pristine_tiled</span><span class="p">,</span> <span class="n">is_not_wind</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_NEP_wind_recycling"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_NEP_wind_recycling">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_NEP_wind_recycling</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find material classified as non-externally-processed wind recycling.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;is_NEP_wind_recycling&#39;] ( np.ndarray ) : Result.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">pristine_tiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_pristine&#39;</span> <span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_snaps</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_NEP_wind_recycling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="p">[</span> <span class="n">pristine_tiled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_wind&#39;</span> <span class="p">)</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_merger_star"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_merger_star">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_merger_star</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find material classified as a merger, while being a star particle at time of first accretion.</span>
<span class="sd">        Caution: This is calculated at the snapshot first after accretion. The safer option may be to calculate at the</span>
<span class="sd">        snapshot immediately before first accretion.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;is_merger_star&#39;] ( np.ndarray ) : Result.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">is_star_first_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_first_acc</span><span class="p">(</span> <span class="s1">&#39;PType&#39;</span> <span class="p">)</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">PTYPE_STAR</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_merger_star&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="p">[</span> <span class="n">is_star_first_acc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_merger&#39;</span> <span class="p">)</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_merger_gas"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_merger_gas">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_merger_gas</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find material classified as a merger, while being gas at time of first accretion.</span>
<span class="sd">        Caution: This is calculated at the snapshot first after accretion. The safer option may be to calculate at the</span>
<span class="sd">        snapshot immediately before first accretion.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;is_merger_gas&#39;] ( np.ndarray ) : Result.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">is_star_first_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_first_acc</span><span class="p">(</span> <span class="s1">&#39;PType&#39;</span> <span class="p">)</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">PTYPE_GAS</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_merger_gas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="p">[</span> <span class="n">is_star_first_acc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_merger&#39;</span> <span class="p">)</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_classification_NYA"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_classification_NYA">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_classification_NYA</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">classification</span><span class="p">,</span>
        <span class="n">tile_classification</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find material with the given classification that is not yet accreted (NYA) onto the main galaxy.</span>

<span class="sd">        Args:</span>
<span class="sd">            classification (str) :</span>
<span class="sd">                What classification to get the result for.</span>

<span class="sd">            tile_classification (bool) :</span>
<span class="sd">                If True, then the input classification should be tiled.</span>

<span class="sd">        Returns:</span>
<span class="sd">            is_classification_NYA ( [n_particles, n_snaps] np.ndarray ) :</span>
<span class="sd">                The (i,j)th entry is True if particle i is not yet</span>
<span class="sd">                accreted by the jth index.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">tile_classification</span><span class="p">:</span>
            <span class="n">classification_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_tiled&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">classification</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">classification_key</span> <span class="o">=</span> <span class="n">classification</span>

        <span class="c1"># Get the classification out first, tiled</span>
        <span class="n">is_classification_NYA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_processed_data</span><span class="p">(</span> <span class="n">classification_key</span> <span class="p">)</span>

        <span class="c1"># Find the indices after accreting</span>
        <span class="n">ind_first_acc_tiled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_processed_data</span><span class="p">(</span> <span class="s1">&#39;ind_first_acc_tiled&#39;</span> <span class="p">)</span>
        <span class="n">ind_tiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_snaps</span> <span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">has_accreted</span> <span class="o">=</span> <span class="n">ind_tiled</span> <span class="o">&lt;=</span> <span class="n">ind_first_acc_tiled</span>

        <span class="c1"># Update the classification to mask first accretion.</span>
        <span class="n">is_classification_NYA</span><span class="p">[</span><span class="n">has_accreted</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">is_classification_NYA</span></div>

<div class="viewcode-block" id="Worldlines.calc_is_NEP_NYA"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_NEP_NYA">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_NEP_NYA</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find material classified as NEP that is not yet accreted (NYA) onto the main galaxy.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;is_mass_transfer_NYA&#39;] ( np.ndarray ) : Result</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_NEP_NYA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_is_classification_NYA</span><span class="p">(</span> <span class="s1">&#39;is_pristine&#39;</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Worldlines.calc_is_hitherto_EP_NYA"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_hitherto_EP_NYA">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_hitherto_EP_NYA</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_hitherto_EP_NYA&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_is_classification_NYA</span><span class="p">(</span>
                <span class="s1">&#39;is_hitherto_EP&#39;</span><span class="p">,</span>
                <span class="n">tile_classification</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Worldlines.calc_is_hitherto_NEP_NYA"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_hitherto_NEP_NYA">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_hitherto_NEP_NYA</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_hitherto_NEP_NYA&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_is_classification_NYA</span><span class="p">(</span>
                <span class="s1">&#39;is_hitherto_NEP&#39;</span><span class="p">,</span>
                <span class="n">tile_classification</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Worldlines.calc_is_merger_NYA"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_merger_NYA">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_merger_NYA</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find material classified as merger that is not yet accreted (NYA) onto the main galaxy.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;is_merger_NYA&#39;] ( np.ndarray ) : Result</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_merger_NYA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_is_classification_NYA</span><span class="p">(</span> <span class="s1">&#39;is_merger&#39;</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Worldlines.calc_is_mass_transfer_NYA"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_mass_transfer_NYA">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_mass_transfer_NYA</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find material classified as mass transfer that is not yet accreted (NYA) onto the main galaxy.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;is_mass_transfer_NYA&#39;] ( np.ndarray ) : Result</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_mass_transfer_NYA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_is_classification_NYA</span><span class="p">(</span> <span class="s1">&#39;is_mass_transfer&#39;</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_IP"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_IP">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_IP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate internally processed material, defined as all material</span>
<span class="sd">        that has been inside the main galaxy.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">is_in_main_gal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_in_main_gal&#39;</span> <span class="p">)</span>

        <span class="n">summed</span> <span class="o">=</span> <span class="n">is_in_main_gal</span><span class="p">[:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)[:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summed</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_in_CGM"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_in_CGM">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_in_CGM</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate material that is in the CGM.&#39;&#39;&#39;</span>

        <span class="n">r_rvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_processed_data</span><span class="p">(</span>
            <span class="s1">&#39;R&#39;</span><span class="p">,</span>
            <span class="n">scale_key</span> <span class="o">=</span> <span class="s1">&#39;Rvir&#39;</span><span class="p">,</span>
            <span class="n">scale_a_power</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
            <span class="n">scale_h_power</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">is_in_CGM_rvir</span> <span class="o">=</span> <span class="p">(</span> <span class="n">r_rvir</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">OUTER_CGM_BOUNDARY</span> <span class="p">)</span> \
            <span class="o">&amp;</span> <span class="p">(</span> <span class="n">r_rvir</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">INNER_CGM_BOUNDARY</span> <span class="p">)</span>

        <span class="n">r_gal_length_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_processed_data</span><span class="p">(</span>
            <span class="s1">&#39;R&#39;</span><span class="p">,</span>
            <span class="n">scale_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;length_scale&#39;</span><span class="p">],</span>
            <span class="n">scale_a_power</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
            <span class="n">scale_h_power</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">is_in_CGM_length_scale</span> <span class="o">=</span> <span class="n">r_gal_length_scale</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">F_GAP</span> <span class="p">)</span> <span class="o">*</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;galaxy_cut&#39;</span><span class="p">]</span>

        <span class="n">is_in_CGM</span> <span class="o">=</span> <span class="n">is_in_CGM_rvir</span> <span class="o">&amp;</span> <span class="n">is_in_CGM_length_scale</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_in_CGM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_in_CGM</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_in_galaxy_halo_interface"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_in_galaxy_halo_interface">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_in_galaxy_halo_interface</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate material that is in the CGM.&#39;&#39;&#39;</span>

        <span class="n">r_rvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_processed_data</span><span class="p">(</span>
            <span class="s1">&#39;R&#39;</span><span class="p">,</span>
            <span class="n">scale_key</span> <span class="o">=</span> <span class="s1">&#39;Rvir&#39;</span><span class="p">,</span>
            <span class="n">scale_a_power</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
            <span class="n">scale_h_power</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">r_gal_length_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_processed_data</span><span class="p">(</span>
            <span class="s1">&#39;R&#39;</span><span class="p">,</span>
            <span class="n">scale_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;length_scale&#39;</span><span class="p">],</span>
            <span class="n">scale_a_power</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
            <span class="n">scale_h_power</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">is_in_outer_boundary</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span> <span class="n">r_rvir</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">INNER_CGM_BOUNDARY</span> <span class="p">)</span> <span class="o">|</span>
            <span class="p">(</span> <span class="n">r_gal_length_scale</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">F_GAP</span> <span class="p">)</span> <span class="o">*</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;galaxy_cut&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">is_in_interface</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">is_in_outer_boundary</span> <span class="o">&amp;</span>
            <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_in_main_gal&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_in_galaxy_halo_interface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_in_interface</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_CGM_satellite"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_CGM_satellite">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_CGM_satellite</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_CGM_satellite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_in_CGM&#39;</span> <span class="p">)</span> \
            <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_in_other_gal&#39;</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_CGM_EP"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_CGM_EP">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_CGM_EP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_CGM_EP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_in_CGM&#39;</span> <span class="p">)</span> \
            <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_hitherto_EP_NYA&#39;</span> <span class="p">)</span> \
            <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_in_other_gal&#39;</span> <span class="p">)</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_CGM_NEP"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_CGM_NEP">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_CGM_NEP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_CGM_NEP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_in_CGM&#39;</span> <span class="p">)</span> \
            <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_hitherto_NEP_NYA&#39;</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_CGM_IP"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_CGM_IP">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_CGM_IP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_CGM_IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_in_CGM&#39;</span> <span class="p">)</span> \
            <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_IP&#39;</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_outside_any_gal_EP"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_outside_any_gal_EP">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_outside_any_gal_EP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="n">is_outside_any_gal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;gal_id&#39;</span> <span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_outside_any_gal_EP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_outside_any_gal</span> \
            <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_hitherto_EP_NYA&#39;</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_outside_any_gal_IP"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_outside_any_gal_IP">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_outside_any_gal_IP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

        <span class="n">is_outside_any_gal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;gal_id&#39;</span> <span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_outside_any_gal_IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_outside_any_gal</span> \
            <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_IP&#39;</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_after_enrichment"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_after_enrichment">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_after_enrichment</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find the snapshots at which the metallicity is different from the</span>
<span class="sd">        prior snapshot.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># Set up the data</span>
        <span class="n">is_after_enrichment_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_data_shape</span> <span class="p">)</span>
        <span class="n">is_after_enrichment_full</span> <span class="o">=</span> <span class="n">is_after_enrichment_full</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Get values for most of the data</span>
        <span class="n">met_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;Z&#39;</span> <span class="p">)[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;Z&#39;</span> <span class="p">)[:,</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">is_after_enrichment</span> <span class="o">=</span> <span class="n">met_diff</span> <span class="o">&gt;</span> <span class="mf">1e-6</span>

        <span class="c1"># Get values for the earliest traced snapshot</span>
        <span class="c1"># (We assume enrichement if above the metallicity floor of 1e-3 to </span>
        <span class="c1"># 1e-4, plus a little room. )</span>
        <span class="n">is_after_enrichment_first_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;Z&#39;</span> <span class="p">)[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">2e-3</span>

        <span class="c1"># Combine the data</span>
        <span class="n">is_after_enrichment_full</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_after_enrichment</span>
        <span class="n">is_after_enrichment_full</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_after_enrichment_first_snap</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_after_enrichment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_after_enrichment_full</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_before_enrichment"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_before_enrichment">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_before_enrichment</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find the snapshots at which the metallicity is different from the</span>
<span class="sd">        next snapshot.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># Set up the data</span>
        <span class="n">is_before_enrichment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_data_shape</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>

        <span class="c1"># Get the values</span>
        <span class="n">after_enrichment_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_after_enrichment&#39;</span> <span class="p">)[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">is_before_enrichment</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">after_enrichment_vals</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_before_enrichment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_before_enrichment</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_enriched"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_enriched">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_enriched</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find the snapshots at which the metallicity is different from the</span>
<span class="sd">        either the next snapshot or the previous snapshot.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_enriched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mask_or</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_after_enrichment&#39;</span> <span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_before_enrichment&#39;</span> <span class="p">),</span>
        <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_enriched_in_mgal"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_enriched_in_mgal">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_enriched_in_mgal</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find the snapshots at which the metallicity is different from the</span>
<span class="sd">        either the next snapshot or the previous snapshot, and the particle</span>
<span class="sd">        is inside the radius of the main galaxy (note that no density threshold</span>
<span class="sd">        is applied).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Get when not in the radius of the main galaxy</span>
        <span class="n">mt_gal_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;mt_gal_id&#39;</span> <span class="p">)</span>
        <span class="n">main_mt_halo_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;main_mt_halo_id&#39;</span><span class="p">]</span>
        <span class="n">is_in_mgal</span> <span class="o">=</span> <span class="n">mt_gal_id</span> <span class="o">==</span> <span class="n">main_mt_halo_id</span>

        <span class="c1"># Now get when enriched and in another galaxy.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_enriched_in_mgal&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">is_in_mgal</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_enriched&#39;</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_is_enriched_in_ogal"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_is_enriched_in_ogal">[docs]</a>    <span class="k">def</span> <span class="nf">calc_is_enriched_in_ogal</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find the snapshots at which the metallicity is different from the</span>
<span class="sd">        either the next snapshot or the previous snapshot, and the particle</span>
<span class="sd">        is inside the radius of another galaxy (note that no density threshold</span>
<span class="sd">        is applied).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Get when not in the radius of the main galaxy</span>
        <span class="n">mt_gal_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;mt_gal_id&#39;</span> <span class="p">)</span>
        <span class="n">main_mt_halo_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galids</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;main_mt_halo_id&#39;</span><span class="p">]</span>
        <span class="n">is_not_in_main_gal</span> <span class="o">=</span> <span class="n">mt_gal_id</span> <span class="o">!=</span> <span class="n">main_mt_halo_id</span>

        <span class="c1"># Get when in the radius of any galaxy</span>
        <span class="n">gal_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;gal_id&#39;</span> <span class="p">)</span>
        <span class="n">is_in_gal</span> <span class="o">=</span> <span class="n">gal_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span>

        <span class="c1"># Get when in the radius of a galaxy other than the main galaxy</span>
        <span class="n">is_in_ogal</span> <span class="o">=</span> <span class="n">is_in_gal</span> <span class="o">&amp;</span> <span class="n">is_not_in_main_gal</span>

        <span class="c1"># Now get when enriched and in another galaxy.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_enriched_in_ogal&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">is_in_ogal</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_enriched&#39;</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_time"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_time">[docs]</a>    <span class="k">def</span> <span class="nf">calc_time</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calc current time in the simulation.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;time&#39;] (np.ndarray) :</span>
<span class="sd">                The value at index i is the time in the simulation</span>
<span class="sd">                (i.e. the age of the universe) at that index.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Age of the universe in Gyr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">astro_tools</span><span class="o">.</span><span class="n">age_of_universe</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;redshift&#39;</span> <span class="p">),</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">data_attrs</span><span class="p">[</span><span class="s1">&#39;hubble&#39;</span><span class="p">],</span>
            <span class="n">omega_matter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptracks</span><span class="o">.</span><span class="n">data_attrs</span><span class="p">[</span><span class="s1">&#39;omega_matter&#39;</span><span class="p">],</span>
        <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_dt"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_dt">[docs]</a>    <span class="k">def</span> <span class="nf">calc_dt</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calc time difference between snapshots.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;dt&#39;] (np.ndarray) : self.data[&#39;dt&#39;][i] = light_travel_time[i+1] - light_travel_time[i]</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Age of the universe in Myr</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;time&#39;</span> <span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># dt is shorter than the standard array, so we need to pad the array at the final snapshot</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">dt</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">FLOAT_FILL_VALUE</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_t_EP"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_t_EP">[docs]</a>    <span class="k">def</span> <span class="nf">calc_t_EP</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate the time spent in another galaxy prior to accretion onto the main galaxy of the simulation.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;t_EP&#39;] (np.ndarray) :</span>
<span class="sd">                self.data[&#39;t_EP&#39;][i] = time particle i spent in another galaxy prior to first accretion.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Make sure we have a fresh slate to work with.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_masker</span><span class="o">.</span><span class="n">clear_masks</span><span class="p">()</span>

        <span class="c1"># Make sure we only include time when the particle is in another galaxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_masker</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;is_in_other_gal&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="c1"># Get the individual pieces of time, prior to adding them up.</span>
        <span class="n">dt_masked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_data</span><span class="p">(</span> <span class="s1">&#39;dt_tiled&#39;</span><span class="p">,</span> <span class="n">mask_after_first_acc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>

        <span class="c1"># Now do the sum</span>
        <span class="n">t_EP</span> <span class="o">=</span> <span class="n">dt_masked</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>

        <span class="c1"># Save the data, with fully masked data filled in with 0&#39;s (because that&#39;s how long it&#39;s spent)</span>
        <span class="n">t_EP</span><span class="o">.</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;t_EP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_EP</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e3</span> <span class="c1"># It&#39;s typically easier to look at this in Myr</span>

        <span class="c1"># Clear the masks again so we don&#39;t affect future things.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_masker</span><span class="o">.</span><span class="n">clear_masks</span><span class="p">()</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_d_sat_scaled_min"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_d_sat_scaled_min">[docs]</a>    <span class="k">def</span> <span class="nf">calc_d_sat_scaled_min</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate the minimum distance to a a galaxy other than the main galaxy, prior to accretion onto the main gal.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;d_sat_scaled_min&#39;] (np.ndarray of shape (n_particles,)) :</span>
<span class="sd">                self.data[&#39;d_sat_scaled_min&#39;][i] = min( d_sat_scaled, prior to first acc for particle i )</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;d_sat_scaled&#39;</span> <span class="p">)</span>

        <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span> <span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span> <span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_masker</span><span class="o">.</span><span class="n">get_mask</span><span class="p">(</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask2</span><span class="p">,</span> <span class="n">mask_after_first_acc</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="n">d_ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span> <span class="n">d</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;d_sat_scaled_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_ind"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_ind">[docs]</a>    <span class="k">def</span> <span class="nf">calc_ind</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Just the redshift index for each array.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_snaps</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_ind_particle"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_ind_particle">[docs]</a>    <span class="k">def</span> <span class="nf">calc_ind_particle</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Just the particle index for each array.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ind_particle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="Worldlines.calc_ind_star"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.Worldlines.calc_ind_star">[docs]</a>    <span class="k">def</span> <span class="nf">calc_ind_star</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate the index at which a particle is first recorded as being a star.</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.data[&#39;ind_star&#39;] (np.ndarray of shape (n_particles,)) :</span>
<span class="sd">                self.data[&#39;ind_star&#39;][i] = Index at which particle is first recorded as being a star.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ptype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;PType&#39;</span> <span class="p">)</span>

        <span class="n">is_star</span> <span class="o">=</span> <span class="n">ptype</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">PTYPE_STAR</span>

        <span class="c1"># Find the first index the particle was last a gas particle</span>
        <span class="n">ind_last_gas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span> <span class="n">is_star</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>

        <span class="c1"># This is correct for most cases.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ind_star&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind_last_gas</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># We need to correct entries which are always star or always gas</span>
        <span class="n">always_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="n">is_star</span> <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">always_gas</span> <span class="o">=</span> <span class="n">is_star</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ind_star&#39;</span><span class="p">][</span><span class="n">always_star</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ind_star&#39;</span><span class="p">][</span><span class="n">always_gas</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">INT_FILL_VALUE</span></div></div>

<span class="c1">########################################################################</span>
<span class="c1">########################################################################</span>


<div class="viewcode-block" id="WorldlineDataMasker"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker">[docs]</a><span class="k">class</span> <span class="nc">WorldlineDataMasker</span><span class="p">(</span> <span class="n">simulation_data</span><span class="o">.</span><span class="n">TimeDataMasker</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Data masker for worldline data.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">worldlines</span> <span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span> <span class="n">WorldlineDataMasker</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="n">worldlines</span> <span class="p">)</span>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataMasker.get_mask"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker.get_mask">[docs]</a>    <span class="k">def</span> <span class="nf">get_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">classification</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_after_first_acc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">mask_before_first_acc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_mask_shape</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">optional_masks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a mask for the data.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (np.array) :</span>
<span class="sd">                Mask to apply to the data. If None, use the masks stored in self.masks (which Nones to empty).</span>

<span class="sd">            classification (str) :</span>
<span class="sd">                If provided, only select particles that meet this classification, as given in</span>
<span class="sd">                self.data_object.classifications.data</span>

<span class="sd">            tile_classification_mask (bool) :</span>
<span class="sd">                Whether or not to tile the classification mask. True for most data that&#39;s time dependent, but False</span>
<span class="sd">                for data that&#39;s one value per particle.</span>

<span class="sd">            mask_after_first_acc (bool) :</span>
<span class="sd">                If True, only select particles above first accretion.</span>

<span class="sd">            mask_before_first_acc (bool) :</span>
<span class="sd">                If True, only select particles after first accretion.</span>

<span class="sd">            preserve_mask_shape (bool) :</span>
<span class="sd">                If True, don&#39;t tile masks that are single dimensional, and one per particle.</span>

<span class="sd">            optional_masks (list-like) :</span>
<span class="sd">                If given, the optional masks to include, by name (masks must be available in self.optional_masks).</span>

<span class="sd">        Returns:</span>
<span class="sd">            mask (bool np.ndarray) :</span>
<span class="sd">                Mask from all the combinations.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">used_masks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">optional_masks</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">total_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_mask</span><span class="p">(</span>
                    <span class="n">optional_masks</span><span class="o">=</span><span class="n">optional_masks</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">total_mask</span> <span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                    <span class="n">used_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">total_mask</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">total_mask</span><span class="p">:</span>
                    <span class="n">used_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">total_mask</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Tile mask if it&#39;s single-dimensional</span>
            <span class="k">if</span> <span class="p">(</span> <span class="ow">not</span> <span class="n">preserve_mask_shape</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="p">)</span> <span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">n_snaps</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

            <span class="n">used_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">mask</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">classification</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">cl_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">classification</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cl_mask</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="ow">not</span> <span class="n">preserve_mask_shape</span> <span class="p">):</span>
                <span class="n">cl_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">cl_mask</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">n_snaps</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">used_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">cl_mask</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">mask_after_first_acc</span> <span class="ow">or</span> <span class="n">mask_before_first_acc</span><span class="p">:</span>

            <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span> <span class="n">mask_after_first_acc</span> <span class="ow">and</span> <span class="n">mask_before_first_acc</span> <span class="p">),</span> \
                <span class="s2">&quot;Attempted to mask both before and after first acc.&quot;</span>

            <span class="n">ind_first_acc_tiled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">get_processed_data</span><span class="p">(</span> <span class="s1">&#39;ind_first_acc_tiled&#39;</span> <span class="p">)</span>
            <span class="n">ind_tiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">n_snaps</span> <span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">mask_after_first_acc</span><span class="p">:</span>
                <span class="n">first_acc_mask</span> <span class="o">=</span> <span class="n">ind_tiled</span> <span class="o">&lt;=</span> <span class="n">ind_first_acc_tiled</span>
            <span class="k">elif</span> <span class="n">mask_before_first_acc</span><span class="p">:</span>
                <span class="n">first_acc_mask</span> <span class="o">=</span> <span class="n">ind_tiled</span> <span class="o">&gt;</span> <span class="n">ind_first_acc_tiled</span>
            <span class="n">used_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">first_acc_mask</span> <span class="p">)</span>

        <span class="c1"># Combine the masks</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span> <span class="n">used_masks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">mask</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataMasker.get_selected_data"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker.get_selected_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_selected_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_key</span><span class="p">,</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">classification</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_after_first_acc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">mask_before_first_acc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_mask_shape</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">optional_masks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get masked worldline data. Extra arguments are passed to the ParentClass&#39; get_selected_data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_key (str) :</span>
<span class="sd">                Data to get.</span>

<span class="sd">            mask (np.array) :</span>
<span class="sd">                Mask to apply to the data. If None, use the masks stored in self.masks (which Nones to empty).</span>

<span class="sd">            classification (str) :</span>
<span class="sd">                If provided, only select particles that meet this classification, as given in</span>
<span class="sd">                self.data_object.classifications.data</span>

<span class="sd">            tile_classification_mask (bool) :</span>
<span class="sd">                Whether or not to tile the classification mask. True for most data that&#39;s time dependent, but False</span>
<span class="sd">                for data that&#39;s one value per particle.</span>

<span class="sd">            mask_after_first_acc (bool) :</span>
<span class="sd">                If True, only select particles above first accretion.</span>

<span class="sd">            mask_before_first_acc (bool) :</span>
<span class="sd">                If True, only select particles after first accretion.</span>

<span class="sd">            preserve_mask_shape (bool) :</span>
<span class="sd">                If True, don&#39;t tile masks that are single dimensional, and one per particle.</span>

<span class="sd">        Returns:</span>
<span class="sd">            masked_data (np.array) :</span>
<span class="sd">                Flattened array of masked data.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">used_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mask</span><span class="p">(</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">,</span>
            <span class="n">classification</span> <span class="o">=</span> <span class="n">classification</span><span class="p">,</span>
            <span class="n">mask_after_first_acc</span> <span class="o">=</span> <span class="n">mask_after_first_acc</span><span class="p">,</span>
            <span class="n">mask_before_first_acc</span> <span class="o">=</span> <span class="n">mask_before_first_acc</span><span class="p">,</span>
            <span class="n">preserve_mask_shape</span> <span class="o">=</span> <span class="n">preserve_mask_shape</span><span class="p">,</span>
            <span class="n">optional_masks</span> <span class="o">=</span> <span class="n">optional_masks</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">masked_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span> <span class="n">WorldlineDataMasker</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span><span class="o">.</span><span class="n">get_selected_data</span><span class="p">(</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">used_mask</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">masked_data</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataMasker.get_selected_data_over_time"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker.get_selected_data_over_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_selected_data_over_time</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_key</span><span class="p">,</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">classification</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_after_first_acc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">mask_before_first_acc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_mask_shape</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">optional_masks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get masked worldline data. Extra arguments are passed to the ParentClass&#39; get_selected_data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_key (str) :</span>
<span class="sd">                Data to get.</span>

<span class="sd">            mask (np.array) :</span>
<span class="sd">                Mask to apply to the data. If None, use the masks stored in self.masks (which defaults to empty).</span>

<span class="sd">            classification (str) :</span>
<span class="sd">                If provided, only select particles that meet this classification, as given in</span>
<span class="sd">                self.data_object.classifications.data</span>

<span class="sd">            tile_classification_mask (bool) :</span>
<span class="sd">                Whether or not to tile the classification mask. True for most data that&#39;s time dependent, but False</span>
<span class="sd">                for data that&#39;s one value per particle.</span>

<span class="sd">            mask_after_first_acc (bool) :</span>
<span class="sd">                If True, only select particles above first accretion.</span>

<span class="sd">            mask_before_first_acc (bool) :</span>
<span class="sd">                If True, only select particles after first accretion.</span>

<span class="sd">            preserve_mask_shape (bool) :</span>
<span class="sd">                If True, don&#39;t tile masks that are single dimensional, and one per particle.</span>

<span class="sd">        Returns:</span>
<span class="sd">            masked_data (np.array) :</span>
<span class="sd">                Flattened array of masked data.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">used_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mask</span><span class="p">(</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">,</span>
            <span class="n">classification</span> <span class="o">=</span> <span class="n">classification</span><span class="p">,</span>
            <span class="n">mask_after_first_acc</span> <span class="o">=</span> <span class="n">mask_after_first_acc</span><span class="p">,</span>
            <span class="n">mask_before_first_acc</span> <span class="o">=</span> <span class="n">mask_before_first_acc</span><span class="p">,</span>
            <span class="n">preserve_mask_shape</span> <span class="o">=</span> <span class="n">preserve_mask_shape</span><span class="p">,</span>
            <span class="n">optional_masks</span> <span class="o">=</span> <span class="n">optional_masks</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">super_class</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span> <span class="n">WorldlineDataMasker</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span>
        <span class="n">masked_data</span> <span class="o">=</span> <span class="n">super_class</span><span class="o">.</span><span class="n">get_selected_data_over_time</span><span class="p">(</span>
            <span class="n">data_key</span><span class="p">,</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">used_mask</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">masked_data</span></div>

    <span class="c1">########################################################################</span>
    <span class="c1"># Selection routines</span>
    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataMasker.run_selection_routine"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker.run_selection_routine">[docs]</a>    <span class="k">def</span> <span class="nf">run_selection_routine</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">selection_routine</span><span class="p">,</span> <span class="n">ptype</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Selection routines are routines for adding non-trivial combinations of masks to self.masks.</span>
<span class="sd">        Masked data then will be retrieved with these masks in mind.</span>

<span class="sd">        Args:</span>
<span class="sd">            selection_routine (str) :</span>
<span class="sd">                What selection routine to run? If None, don&#39;t run any.</span>

<span class="sd">            ptype (str) :</span>
<span class="sd">                What particle type to select?</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.masks (list) :</span>
<span class="sd">                Clears and adds masks to self.masks.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">selection_routine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;star&#39;</span><span class="p">:</span>
            <span class="n">ptype_value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">PTYPE_STAR</span>
        <span class="k">elif</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;gas&#39;</span><span class="p">:</span>
            <span class="n">ptype_value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">PTYPE_GAS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s2">&quot;Unrecognized Particle Type, ptype = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">ptype</span> <span class="p">)</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_masks</span><span class="p">()</span>

        <span class="nb">getattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;select_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">selection_routine</span> <span class="p">)</span> <span class="p">)(</span> <span class="n">ptype_value</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataMasker.select_ptype"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker.select_ptype">[docs]</a>    <span class="k">def</span> <span class="nf">select_ptype</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ptype_value</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Simple selection routine for only selecting particle type.</span>

<span class="sd">        Args:</span>
<span class="sd">            selection_routine (str) :</span>
<span class="sd">                What selection routine to run? If None, don&#39;t run any.</span>

<span class="sd">            ptype (str) :</span>
<span class="sd">                What particle type to select?</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.masks (list) :</span>
<span class="sd">                Clears and adds masks to self.masks.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;PType&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="n">ptype_value</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataMasker.select_galaxy"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker.select_galaxy">[docs]</a>    <span class="k">def</span> <span class="nf">select_galaxy</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ptype_value</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This selection routine selects only particles in a galaxy.</span>

<span class="sd">        ptype_value (int) :</span>
<span class="sd">            In the data, what ptype do we select?</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.masks (list) :</span>
<span class="sd">                Adds masks needed to select only particles in a galaxy.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;PType&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="n">ptype_value</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;is_in_main_gal&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataMasker.select_accreted"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker.select_accreted">[docs]</a>    <span class="k">def</span> <span class="nf">select_accreted</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ptype_value</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This selection routine selects only particles that are the snapshot before being accreted.</span>

<span class="sd">        ptype_value (int) :</span>
<span class="sd">            In the data, what ptype do we select?</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.masks (list) :</span>
<span class="sd">                Adds masks needed to select only particles in a galaxy.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;PType&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="n">ptype_value</span> <span class="p">)</span>

        <span class="c1"># Because `is_accreted` has one less column, we need to adjust the shape before we add the mask.</span>
        <span class="n">adjusted_accreted_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">n_snaps</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="n">adjusted_accreted_mask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_object</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;is_accreted&#39;</span> <span class="p">)</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;is_accreted&#39;</span><span class="p">,</span> <span class="n">custom_mask</span><span class="o">=</span><span class="n">adjusted_accreted_mask</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataMasker.select_outside_all_galaxies"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker.select_outside_all_galaxies">[docs]</a>    <span class="k">def</span> <span class="nf">select_outside_all_galaxies</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ptype_value</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This seleciton routine selects only particles that are outside all galaxies.</span>

<span class="sd">        ptype_value (int) :</span>
<span class="sd">            In the data, what ptype do we select?</span>

<span class="sd">        Modifies:</span>
<span class="sd">            self.masks (list) :</span>
<span class="sd">                Adds masks needed to select only particles outside all galaxies.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;PType&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="n">ptype_value</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;is_in_main_gal&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;is_in_other_gal&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span></div>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataMasker.select_in_CGM"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataMasker.select_in_CGM">[docs]</a>    <span class="k">def</span> <span class="nf">select_in_CGM</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ptype_value</span> <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;PType&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="n">ptype_value</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask_data</span><span class="p">(</span> <span class="s1">&#39;is_in_CGM&#39;</span><span class="p">,</span> <span class="n">data_value</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span></div></div>

<span class="c1">########################################################################</span>
<span class="c1">########################################################################</span>


<div class="viewcode-block" id="WorldlineDataKeyParser"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataKeyParser">[docs]</a><span class="k">class</span> <span class="nc">WorldlineDataKeyParser</span><span class="p">(</span> <span class="n">generic_data</span><span class="o">.</span><span class="n">DataKeyParser</span> <span class="p">):</span>

    <span class="c1">########################################################################</span>

<div class="viewcode-block" id="WorldlineDataKeyParser.is_tiled_key"><a class="viewcode-back" href="../../../linefinder.analyze_data.worldlines.html#linefinder.analyze_data.worldlines.WorldlineDataKeyParser.is_tiled_key">[docs]</a>    <span class="k">def</span> <span class="nf">is_tiled_key</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data_key</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Parse the data key for tiled data.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">data_key</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_tiled&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_key</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">],</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_key</span><span class="p">,</span> <span class="kc">False</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Zachary Hafen.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>